<!doctype html><html lang=en><head><title>How I sped up demo data generation by 97% · Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="Let's go on a ride of learning metaprogramming in PostgreSQL together"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="How I sped up demo data generation by 97%"><meta name=twitter:description content="Let's go on a ride of learning metaprogramming in PostgreSQL together"><meta property="og:title" content="How I sped up demo data generation by 97%"><meta property="og:description" content="Let's go on a ride of learning metaprogramming in PostgreSQL together"><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/metaprogramming-in-postgresql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-20T00:00:00+00:00"><link rel=canonical href=https://justinbarclay.ca/posts/metaprogramming-in-postgresql/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/metaprogramming-in-postgresql/>How I sped up demo data generation by 97%</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-03-20T00:00:00Z>March 20, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
29-minute read</span></div></div></header><div class=post-content><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>…or how I chose to copy data instead of generating it</h3><div id=outline-text-headline-1 class=outline-text-3><p>TLDR; Move from as much work as possible from Ruby on Rails into SQL</p><img src=/images/a-cyberpunk-astronaut-feigning-surprise-vaporwave.png alt='"A woman feigning surprise"' title=/images/a-cyberpunk-astronaut-feigning-surprise-vaporwave.png style=width:100%><p>Shocking, I know.</p><blockquote class=not-prose><p>I find it best to play with code to see how it really works. So all the code in this post is meant as a playground. In fact, that was most of the impetus for writing this in general; I wrote it as I explored and tried to understand the SQL functionality. As such, I've broken out <strong>most</strong> of the SQL so you can paste it into a psql REPL and play around with it. Or if you're a cool kid, like me, I've set up a <a href=https://gitpod.io/#https://github.com/justinbarclay/copy-schema-demo>gitpod</a>, but if you're new to Emacs, I recommend perusing the first <a href=https://github.com/justinbarclay/copy-schema-demo>cheatsheet</a> first.</p></blockquote></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Why work on this?</h2><div id=outline-text-headline-2 class=outline-text-2><p>For my job I was tasked with working on a project that would seed a new schema with a large set of data for each new client. This operation would take 10 minutes in our production environment, and on my poor dev machine, it would take upwards of 30 minutes in a development environment. We implemented some optimizations to the process: instead of inserting data one query at a time, we shaved our process time by half when we started bulk inserting rows. But this wasn't enough for me, and I felt we could do better.</p><blockquote><p>I can hear you saying… "30 minutes? That's insane. How did you let it get so bad?" Look, mistakes were made, OK? But I am trying to learn from them out in the open. And in this case, I'm looking to take you along this specifically painful journey.</p></blockquote><p>Knowing that this could be done better, I did some research. Can we somehow move a lot of this initial logic from Rails to SQL? I thought about just generating all the seed data in pure SQL and running those seed files whenever we needed to seed a schema. That seemed messy and unmaintainable, not only because I like maintaining Ruby over SQL but because we had some highly related data, which would mean importing some of our business logic into these seed files to maintain those relationships. So, could we export a copy of a schema and then import the entire schema based on some script? I found <code>pg_dump</code>, which could export schema structures, or you could dump and load an entire database. But my initial search didn't find anything around exporting and re-importing a schema <em>and</em> its data.</p><p>Instead, I chose to dive deeper. That led me on a short journey into the PostgreSQL wiki, where I found an <a href=https://wiki.postgresql.org/wiki/Clone_schema>article</a> that talked about cloning the data from one schema onto another schema. I thought that was brilliant. We could maintain our seed data generation process in Ruby, import it into a demo data schema, and then clone from that schema whenever we instantiated a new schema for a user. And this article was really close to what I wanted, but it did not clone some essential information about those tables. So, that meant that we were missing essential things like sequences and foreign key relations when we cloned schemas. Luckily this article referenced a more complete <a href=https://www.postgresql.org/message-id/CANu8FiyJtt-0q%3DbkUxyra66tHi6FFzgU8TqVR2aahseCBDDntA%40mail.gmail.com>mailing list post</a> that goes over how to copy all the data, including metadata, from a source schema into a destination schema.</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>Using Pure SQL to Copy Schemas</h2><div id=outline-text-headline-3 class=outline-text-2><p>When I started this adventure, I knew very little about SQL and less so about the variant we used, <a href=https://www.postgresql.org/docs/15/plpgsql.html>PL/pgSQL</a>. I knew enough to write some select statements and, maybe, do a join or two. I never really considered it for anything more. But, apparently, it's a Turing Complete language 🤯. I mean… It's not pretty, but it works.</p><p>Now, I had a pretty good idea of what I wanted to do from a high level. We want to use a schema, called <code>demo</code>, to cache any demo data generation. Then, when we want to populate an account schema with demo data, we copy data from the <code>demo</code> schema into the client schema.</p><p>I knew the function on that mailing list was supposed to do what I wanted. But I understood almost none of it. What sort of developer would I be if I blindly copied and pasted this code into production? So, I read through the function line by line. I poked and prodded and teased it apart until I could understand it. Now, I want to explain this code very explicitly to you. You, my one reader. My one lovely, endearing reader. How else can I prove that I understand something unless I can explain it to someone else?</p><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Syntax Preamble</h3><div id=outline-text-headline-4 class=outline-text-3><p>Before I scare you with a lovecraftian horror of SQL, a behemoth 200 line schema cloning function, I need to lay some groundwork. I expect that you'll have some SQL knowledge. Like you'll have used <code>SELECT</code> and <code>INSERT</code> and <code>JOINS</code> and know what a SQL Schema is. Maybe, you haven't heard of functions though. And this mess of an article is based on understanding a single SQL function and I use SQL functions to play with singular concepts. So, you should know what they are, what they look like, what part of your brain they like to gnaw on at 3 am.</p><blockquote class=not-prose><p>Note: If you have something gnawing on your amygdala at 3 am, it's probably not something SQL will cure. I suggest finding a witch doctor.</p></blockquote><p>If you are already an expert SQList, feel free to <a href=#headline-7>skip this section</a>.</p><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>SQL Functions</h4><div id=outline-text-headline-5 class=outline-text-4><p>In the code block below is a simple version of the function syntax. Some items are optional, like, you don't need to have an <code>OR</code> or a <code>REPLACE</code>, you don't need to have any arguments, and you don't have to declare any variables.</p><p>What you do have to do is say you're creating a function with some name and that it has a body, and then you can do 0 or more things in that body.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>FUNCTION</span> demo_func(
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      source_schema <span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURNS</span> void <span style=color:#ff79c6>AS</span>
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>DECLARE</span>
</span></span><span style=display:flex><span>    src_oid          oid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>--  ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>END</span>;
</span></span><span style=display:flex><span>  $BODY$</span></span></code></pre></div></div><p>For those like me who like to push the boundaries, below is the least amount of code I could write to define a function and still make postgres happy.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>FUNCTION</span> func ()
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURNS</span> void
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>AS</span> $BODY$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span>
</span></span><span style=display:flex><span>  $BODY$</span></span></code></pre></div></div><p>That's not very helpful though, is it?</p><p>You can also have anonymous functions, where they operate just like a regular function but lack a name, arguments or the ability to return anything. Anonymous functions are suitable for when you need to do some work, and you need the full power of the PL/pgSQL language (loops, conditionals, logs/errors), but you don't need to name it or return anything.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>do</span> $$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>DECLARE</span>
</span></span><span style=display:flex><span>    src_oid oid;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- Do Stuff here
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>END</span>
</span></span><span style=display:flex><span>  $$;</span></span></code></pre></div></div><blockquote class=not-prose><p>This might be your first time seeing an oid type, oid stands for <a href=https://www.postgresql.org/docs/current/datatype-oid.html>object identifier</a>. Within our work here we use oids to reference specific pieces of meta information like references to tables or function definitions. If you're familiar with languages like C you can think of them as something like pointers.</p></blockquote></div></div><div id=outline-container-headline-6 class=outline-4><h4 id=headline-6>For loops!</h4><div id=outline-text-headline-6 class=outline-text-4><p>Like most modern languages, PL/pgSQL has <code>for loops</code>. However, it does have a restriction, loops can only run within function calls.</p><p>To write a for loop in an anonymous function, it would look something like this:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>do</span> $$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>FOR</span> counter <span style=color:#ff79c6>IN</span> <span style=color:#bd93f9>1</span>..<span style=color:#bd93f9>5</span> LOOP
</span></span><span style=display:flex><span>     RAISE NOTICE <span style=color:#f1fa8c>&#39;Counter: %&#39;</span>, counter;
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>END</span>
</span></span><span style=display:flex><span>  $$;</span></span></code></pre></div></div><p>If you copy and paste this into a PSQL REPL, you would get output like below:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>NOTICE:  Counter: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>NOTICE:  Counter: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>NOTICE:  Counter: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>NOTICE:  Counter: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>NOTICE:  Counter: <span style=color:#bd93f9>5</span></span></span></code></pre></div></div><p><code>for loops</code>, generally, can work across any iterable item, be it a range, array, or query results.</p></div></div></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>Love and War and Cthulu</h3><div id=outline-text-headline-7 class=outline-text-3><p>For those who just want to see and play with occult artifacts before they understand them, here you are. Though I warn you, this incantation may not summon Cthulu but it probably would summon something like Azathoth.</p><blockquote class=not-prose><p>The function below is slightly modified from the version found on the mailing list. Mainly, it has been modified to work in modern versions of Postres IE. 10 and above.</p></blockquote><button id=expand class=hidden onclick=expand()>Expand code</button>
<button id=collapse onclick=collapse()>Collapse code</button><div class="src src-sql hidden" id=partial-code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#6272a4>-- Function: clone_schema(text, text)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- DROP FUNCTION clone_schema(text, text);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>FUNCTION</span> clone_schema(
</span></span><span style=display:flex><span>      source_schema <span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>      dest_schema <span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>      include_recs <span style=color:#8be9fd;font-style:italic>boolean</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURNS</span> void <span style=color:#ff79c6>AS</span>
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>LANGUAGE</span> plpgsql <span style=color:#ff79c6>VOLATILE</span>
</span></span><span style=display:flex><span>    COST <span style=color:#bd93f9>100</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>FUNCTION</span> clone_schema(<span style=color:#8be9fd;font-style:italic>text</span>, <span style=color:#8be9fd;font-style:italic>text</span>, <span style=color:#8be9fd;font-style:italic>boolean</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>OWNER</span> <span style=color:#ff79c6>TO</span> postgres;</span></span></code></pre></div></div><div class="src src-sql" id=full-code><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#6272a4>-- Function: clone_schema(text, text)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- DROP FUNCTION clone_schema(text, text);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>FUNCTION</span> clone_schema(
</span></span><span style=display:flex><span>      source_schema <span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>      dest_schema <span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>      include_recs <span style=color:#8be9fd;font-style:italic>boolean</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURNS</span> void <span style=color:#ff79c6>AS</span>
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>--  This function will clone all sequences, tables, data, views &amp; functions from any existing schema to a new one
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>-- SAMPLE CALL:
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>-- SELECT clone_schema(&#39;public&#39;, &#39;new_schema&#39;, TRUE);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>DECLARE</span>
</span></span><span style=display:flex><span>    src_oid          oid;
</span></span><span style=display:flex><span>    tbl_oid          oid;
</span></span><span style=display:flex><span>    func_oid         oid;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>object</span>           <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    buffer           <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    srctbl           <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    default_         <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    column_          <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    qry              <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    dest_qry         <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    v_def            <span style=color:#8be9fd;font-style:italic>text</span>;
</span></span><span style=display:flex><span>    seqval           <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_last_value    <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_max_value     <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_start_value   <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_increment_by  <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_min_value     <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_cache_value   <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_log_cnt       <span style=color:#8be9fd;font-style:italic>bigint</span>;
</span></span><span style=display:flex><span>    sq_is_called     <span style=color:#8be9fd;font-style:italic>boolean</span>;
</span></span><span style=display:flex><span>    sq_is_cycled     <span style=color:#8be9fd;font-style:italic>boolean</span>;
</span></span><span style=display:flex><span>    sq_cycled        <span style=color:#8be9fd;font-style:italic>char</span>(<span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- Check that source_schema exists
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>SELECT</span> oid <span style=color:#ff79c6>INTO</span> src_oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> quote_ident(source_schema);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>FOUND</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>      RAISE NOTICE <span style=color:#f1fa8c>&#39;source schema % does not exist!&#39;</span>, source_schema;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span> ;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>-- Check that dest_schema does not yet exist
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    PERFORM nspname 
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> quote_ident(dest_schema);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>FOUND</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>      RAISE NOTICE <span style=color:#f1fa8c>&#39;dest schema % already exists!&#39;</span>, dest_schema;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span> ;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE SCHEMA &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>-- Create sequences
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>-- TODO: Find a way to make this sequence&#39;s owner is the correct table.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> sequence_name::<span style=color:#8be9fd;font-style:italic>text</span> 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.sequences
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>WHERE</span> sequence_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE SEQUENCE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      srctbl :<span style=color:#ff79c6>=</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT last_value, max_value, start_value, increment_by, min_value, cache_value, log_cnt, is_cycled, is_called 
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                FROM &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span> 
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>INTO</span> sq_last_value, sq_max_value, sq_start_value, sq_increment_by, sq_min_value, sq_cache_value, sq_log_cnt, sq_is_cycled, sq_is_called ; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>IF</span> sq_is_cycled 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>          sq_cycled :<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;CYCLE&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>          sq_cycled :<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NO CYCLE&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;ALTER SEQUENCE &#39;</span>   <span style=color:#ff79c6>||</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) 
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; INCREMENT BY &#39;</span> <span style=color:#ff79c6>||</span> sq_increment_by
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; MINVALUE &#39;</span>     <span style=color:#ff79c6>||</span> sq_min_value 
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; MAXVALUE &#39;</span>     <span style=color:#ff79c6>||</span> sq_max_value
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; START WITH &#39;</span>   <span style=color:#ff79c6>||</span> sq_start_value
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; RESTART &#39;</span>      <span style=color:#ff79c6>||</span> sq_min_value 
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; CACHE &#39;</span>        <span style=color:#ff79c6>||</span> sq_cache_value 
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>||</span> sq_cycled <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ;&#39;</span> ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      buffer :<span style=color:#ff79c6>=</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>IF</span> include_recs 
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>THEN</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT setval( &#39;&#39;&#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_last_value <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_is_called <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;);&#39;</span> ; 
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT setval( &#39;&#39;&#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_start_value <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_is_called <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;);&#39;</span> ;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- Create tables 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>TABLE_NAME</span>::<span style=color:#8be9fd;font-style:italic>text</span> 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.tables 
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> table_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;BASE TABLE&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      buffer :<span style=color:#ff79c6>=</span> dest_schema <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE TABLE &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; (LIKE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) 
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; INCLUDING ALL)&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>IF</span> include_recs 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>        <span style=color:#6272a4>-- Insert records from source table
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;INSERT INTO &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; SELECT * FROM &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FOR</span> column_, default_ <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>column_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>, 
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>REPLACE</span>(column_default::<span style=color:#8be9fd;font-style:italic>text</span>, source_schema, dest_schema) 
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>FROM</span> information_schema.COLUMNS 
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> dest_schema 
</span></span><span style=display:flex><span>           <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>TABLE_NAME</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>object</span> 
</span></span><span style=display:flex><span>           <span style=color:#ff79c6>AND</span> column_default <span style=color:#ff79c6>LIKE</span> <span style=color:#f1fa8c>&#39;nextval(%&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;%::regclass)&#39;</span>
</span></span><span style=display:flex><span>      LOOP
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;ALTER TABLE &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ALTER COLUMN &#39;</span> <span style=color:#ff79c6>||</span> column_ <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; SET DEFAULT &#39;</span> <span style=color:#ff79c6>||</span> default_;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>--  add FK constraint
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>FOR</span> qry <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#f1fa8c>&#39;ALTER TABLE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(rn.relname) 
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ADD CONSTRAINT &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(ct.conname) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#ff79c6>||</span> pg_get_constraintdef(ct.oid) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_constraint ct
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>JOIN</span> pg_class rn <span style=color:#ff79c6>ON</span> rn.oid <span style=color:#ff79c6>=</span> ct.conrelid
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> connamespace <span style=color:#ff79c6>=</span> src_oid
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> rn.relkind <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;r&#39;</span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> ct.contype <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;f&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      LOOP
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>EXECUTE</span> qry;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- Create views 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>table_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>             view_definition 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      buffer :<span style=color:#ff79c6>=</span> dest_schema <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> view_definition <span style=color:#ff79c6>INTO</span> v_def
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>table_name</span> <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE OR REPLACE VIEW &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; AS &#39;</span> <span style=color:#ff79c6>||</span> v_def <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span> ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>-- Create functions 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>FOR</span> func_oid <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> oid
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_proc 
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> pronamespace <span style=color:#ff79c6>=</span> src_oid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP      
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> pg_get_functiondef(func_oid) <span style=color:#ff79c6>INTO</span> qry;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>replace</span>(qry, source_schema, dest_schema) <span style=color:#ff79c6>INTO</span> dest_qry;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> dest_qry;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURN</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>LANGUAGE</span> plpgsql <span style=color:#ff79c6>VOLATILE</span>
</span></span><span style=display:flex><span>    COST <span style=color:#bd93f9>100</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>FUNCTION</span> clone_schema(<span style=color:#8be9fd;font-style:italic>text</span>, <span style=color:#8be9fd;font-style:italic>text</span>, <span style=color:#8be9fd;font-style:italic>boolean</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>OWNER</span> <span style=color:#ff79c6>TO</span> postgres;</span></span></code></pre></div></div><p>Woh, insane, right? That's a lot of SQL, and there are words like <code>CREATE</code> and <code>OR</code> and <code>LOOP</code> in there. I need to step back and go section by section to grasp this.</p><blockquote class=not-prose><p>I am done with the jokes and the Cthulu and the like. This is a serious learning article, we need to be serious to be taken seriously.</p></blockquote></div></div></div></div><div id=outline-container-headline-8 class=outline-2><h2 id=headline-8>Let's break it down</h2><div id=outline-text-headline-8 class=outline-text-2><blockquote class=not-prose><p>Some of my examples will include chunks of code wrapped in a function definition. I am doing this because we can easily mimic the calling environment, call special syntax, or get some lovely printout here in org-mode. That means, for the most part, things being functions are an implementation detail and can be safely ignored.</p></blockquote><p>All examples provided are based on <a href=https://hub.docker.com/repository/docker/justinbarclay/clone-schema-demo_beta>this</a> docker image, which is a in turn the schema from the wonderful <a href=https://www.railstutorial.org/book>Ruby on Rails</a> tutorial by Michael Hartl.</p><div id=outline-container-headline-9 class=outline-3><h3 id=headline-9>Metaprogramming in Postgres</h3><div id=outline-text-headline-9 class=outline-text-3><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>FROM</span> pg_namespace;</span></span></code></pre></div></div><p>Postgres keeps tables of information about itself and its state, and they call the collection of metadata <a href=https://www.postgresql.org/docs/13/catalogs.html>systems catalogue</a>. Generally, these tables are prefixed with <code>pg</code>. For example, <a href=https://www.postgresql.org/docs/13/catalog-pg-namespace.html>pg_namespace</a> is a table that contains information about all schemas stored in the database.</p></div></div><div id=outline-container-headline-10 class=outline-3><h3 id=headline-10>Schemas</h3><div id=outline-text-headline-10 class=outline-text-3><p>I assume you know about Schemas because this is a blog post on how to clone one schema to another. However, if you're new to Postgres SQL or have never needed to concern yourself with schemas before, Postgres' <a href=https://www.postgresql.org/docs/current/ddl-schemas.html>docs</a> have a great explanation of why you would have different schemas:</p><blockquote class=not-prose><p>There are several reasons why one might want to use schemas:</p><ul><li>To allow many users to use one database without interfering with each other.</li><li>To organize database objects into logical groups to make them more manageable.</li><li>Third-party applications can be put into separate schemas so they do not collide with the names of other objects.</li></ul></blockquote><div id=outline-container-headline-11 class=outline-4><h4 id=headline-11>Checking for the existence of schema</h4><div id=outline-text-headline-11 class=outline-text-4><p>Knowing about the existence of <code>pg_namespace</code> gives us the ability to understand the first section of code:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#6272a4>-- Check that source_schema exists
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>SELECT</span> oid <span style=color:#ff79c6>INTO</span> src_oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> quote_ident(source_schema);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>FOUND</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>      RAISE NOTICE <span style=color:#f1fa8c>&#39;source schema % does not exist!&#39;</span>, source_schema;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>-- Check that dest_schema does not yet exist
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    PERFORM nspname 
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> quote_ident(dest_schema);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>FOUND</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>      RAISE NOTICE <span style=color:#f1fa8c>&#39;dest schema % already exists!&#39;</span>, dest_schema;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span> ;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE SCHEMA &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) ;</span></span></code></pre></div></div><p>Unfortunately, we can't really run that as pure SQL in its current form. So instead, we need to make it a function so we can normalize the results:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>OR</span> <span style=color:#ff79c6>REPLACE</span> <span style=color:#ff79c6>FUNCTION</span> check_existence(
</span></span><span style=display:flex><span>    source_schema <span style=color:#8be9fd;font-style:italic>text</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURNS</span> bool <span style=color:#ff79c6>AS</span> $BODY$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   PERFORM oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> quote_ident(source_schema);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>IF</span> <span style=color:#ff79c6>NOT</span> <span style=color:#ff79c6>FOUND</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>THEN</span>
</span></span><span style=display:flex><span>      RAISE NOTICE <span style=color:#f1fa8c>&#39;source schema % does not exist!&#39;</span>, source_schema;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>RETURN</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span>;
</span></span><span style=display:flex><span>  $BODY$
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>LANGUAGE</span> plpgsql <span style=color:#ff79c6>VOLATILE</span>
</span></span><span style=display:flex><span>  COST <span style=color:#bd93f9>100</span>;</span></span></code></pre></div></div><p>And then, we can test it to see if a schema does exist:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> check_existence(<span style=color:#f1fa8c>&#39;public&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>check_existence</th></tr></thead><tbody><tr><td>t</td></tr></tbody></table><p></div></p><p>Or to see if a schema name is missing:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> check_existence(<span style=color:#f1fa8c>&#39;backup&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>check_existence</th></tr></thead><tbody><tr><td>f</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-12 class=outline-4><h4 id=headline-12>Creating a schema</h4><div id=outline-text-headline-12 class=outline-text-4><p>Great, now we know that the <code>backup</code> schema doesn't exist. Let's make one. Creating a schema is pretty easy:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span> <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>SCHEMA</span> backup;</span></span></code></pre></div></div><p>Now we can use our function to verify:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> check_existence(<span style=color:#f1fa8c>&#39;backup&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>check_existence</th></tr></thead><tbody><tr><td>t</td></tr></tbody></table><p></div></p></div></div></div></div><div id=outline-container-headline-13 class=outline-3><h3 id=headline-13>Sequences</h3><div id=outline-text-headline-13 class=outline-text-3><p>The next step in copying one schema to another is to copy all of the <a href=https://www.postgresql.org/docs/14/sql-createsequence.html>sequences</a>:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    sequence_name::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    information_schema.sequences
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    sequence_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE SEQUENCE &#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> quote_ident(dest_schema) <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  srctbl: <span style=color:#ff79c6>=</span> quote_ident(source_schema) <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  seq_query: <span style=color:#ff79c6>=</span> format(<span style=color:#f1fa8c>&#39;SELECT max_value, start_value, increment_by, min_value, cache_size, cycle FROM pg_sequences
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                          WHERE sequencename = %L AND schemaname = %L ;&#39;</span>, <span style=color:#ff79c6>object</span>, source_schema);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> seq_query <span style=color:#ff79c6>INTO</span> sq_max_value,
</span></span><span style=display:flex><span>  sq_start_value,
</span></span><span style=display:flex><span>  sq_increment_by,
</span></span><span style=display:flex><span>  sq_min_value,
</span></span><span style=display:flex><span>  sq_cache_value,
</span></span><span style=display:flex><span>  sq_is_cycled;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  seq_query: <span style=color:#ff79c6>=</span> format(<span style=color:#f1fa8c>&#39;SELECT last_value, log_cnt, is_called FROM %s.%s;&#39;</span>, source_schema, <span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> seq_query <span style=color:#ff79c6>INTO</span> sq_last_value,
</span></span><span style=display:flex><span>  sq_log_cnt,
</span></span><span style=display:flex><span>  sq_is_called;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>IF</span> sq_is_cycled <span style=color:#ff79c6>THEN</span>
</span></span><span style=display:flex><span>    sq_cycled: <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;CYCLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>    sq_cycled: <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NO CYCLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  seq_query: <span style=color:#ff79c6>=</span> format(<span style=color:#f1fa8c>&#39;ALTER SEQUENCE %s.%s INCREMENT BY %s MINVALUE %s MAXVALUE %s START WITH %s RESTART %s CACHE %s %s ;&#39;</span>, quote_ident(dest_schema), quote_ident(<span style=color:#ff79c6>object</span>), sq_increment_by, sq_min_value, sq_max_value, sq_start_value, sq_min_value, sq_cache_value, sq_cycled);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> seq_query;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  buffer: <span style=color:#ff79c6>=</span> quote_ident(dest_schema) <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>IF</span> include_recs <span style=color:#ff79c6>THEN</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT setval( &#39;&#39;&#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> buffer <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;&#39;&#39;, &#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> sq_last_value <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;, &#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> sq_is_called <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;);&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT setval( &#39;&#39;&#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> buffer <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;&#39;&#39;, &#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> sq_start_value <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;, &#39;</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> sq_is_called <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>|</span> <span style=color:#f1fa8c>&#39;);&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> LOOP;</span></span></code></pre></div></div><p>Woh, that's a lot to read. Let's break it down.</p><div id=outline-container-headline-14 class=outline-4><h4 id=headline-14>What is a Sequence</h4><div id=outline-text-headline-14 class=outline-text-4><p>A sequence is a special table that generates some sequence of numbers. For instance, Sequences are often used for generating the index values for a table.</p></div></div><div id=outline-container-headline-15 class=outline-4><h4 id=headline-15>Copying Sequence and Values</h4><div id=outline-text-headline-15 class=outline-text-4><p>When copying sequences, we're looking to:</p><ol><li>Get all sequence names from the source schema</li><li>Copy selected sequence names into dest schema</li><li>Populate them with metadata from source sequences</li><li>Update destination schema number to match source schema numbers</li></ol></div></div><div id=outline-container-headline-16 class=outline-4><h4 id=headline-16>1. Get All Sequence Names</h4><div id=outline-text-headline-16 class=outline-text-4><p>If we query Postgres for all sequences attached to the public table:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> sequence_name::<span style=color:#8be9fd;font-style:italic>text</span> 
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>FROM</span> information_schema.sequences
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>WHERE</span> sequence_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>)</span></span></code></pre></div></div><p>We find that we have 6 entries:</p><p><div class=table-scroll></p><table><thead><tr><th>sequence_name</th></tr></thead><tbody><tr><td>users_id_seq</td></tr><tr><td>active_storage_attachments_id_seq</td></tr><tr><td>microposts_id_seq</td></tr><tr><td>active_storage_blobs_id_seq</td></tr><tr><td>active_storage_variant_records_id_seq</td></tr><tr><td>relationships_id_seq</td></tr></tbody></table><p></div>Before we can proceed, we need to ensure our new schema doesn't have any sequences in it:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    sequence_name::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    information_schema.sequences
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    sequence_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;backup&#39;</span>)</span></span></code></pre></div></div><p>It's empty, beautiful:</p><p><div class=table-scroll></p><table><thead><tr><th>sequence_name</th></tr></thead><tbody></tbody></table><p></div></p></div></div><div id=outline-container-headline-17 class=outline-4><h4 id=headline-17>2. Create Sequence</h4><div id=outline-text-headline-17 class=outline-text-4><p>Creating a list of sequences looks like this:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    sequence_name::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    information_schema.sequences
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    sequence_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE SEQUENCE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> LOOP;</span></span></code></pre></div></div><blockquote class=not-prose><p>The more astute of our reader's will notice that we are seeing some new syntax here. <a href=https://www.postgresql.org/docs/current/plpgsql-statements.html#PLPGSQL-STATEMENTS-EXECUTING-DYN><span style=text-decoration:underline>Execute</span></a>, executes a string as if it was pure SQL. This is kind of like a mixture of <a href=http://www.lispworks.com/documentation/lw50/CLHS/Body/f_rd_fro.htm><span style=text-decoration:underline><code>read-from-string</code></span></a> and <a href=http://www.lispworks.com/documentation/lw50/CLHS/Body/f_eval.htm#eval><span style=text-decoration:underline><code>eval</code></span></a> from Lisp. In our case a command-string will be a dynamic SQL command where we interpolate some variables like source schema and destination schema.</p></blockquote><p>Generally, in a schema, there are a lot of sequences. One for each table with an index. So, let's zoom in on one sequence and follow it through the process.</p><p>From the code above, where you see <code>object</code>, we will replace it with <code>microposts_id_seq</code>, one of the values from the above select statement.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> SEQUENCE backup.microposts_id_seq;</span></span></code></pre></div></div><table><tbody><tr><td>CREATE SEQUENCE</td></tr></tbody></table><p></div>And let's take a look at what we made:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>FROM</span> backup.microposts_id_seq;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>last_value</th><th class=align-right>log_cnt</th><th>is_called</th></tr></thead><tbody><tr><td class=align-right>1</td><td class=align-right>0</td><td>f</td></tr></tbody></table><p></div>We made a table that stores values for last_value, log_cnt<sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup>, and is_called<sup class=footnote-reference><a id=footnote-reference-2 href=#footnote-2>2</a></sup>.</p></div></div><div id=outline-container-headline-18 class=outline-4><h4 id=headline-18>3. Copy Sequence Values</h4><div id=outline-text-headline-18 class=outline-text-4><p>Now we're going to fake it a little bit to see what the following statement is doing more easily.</p><p>We can translate:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  seq_query: <span style=color:#ff79c6>=</span> format(<span style=color:#f1fa8c>&#39;SELECT max_value, start_value, increment_by, min_value, cache_size, cycle FROM pg_sequences
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    WHERE sequencename = %L AND schemaname = %L ;&#39;</span>, <span style=color:#ff79c6>object</span>, source_schema);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> seq_query <span style=color:#ff79c6>INTO</span> sq_max_value,
</span></span><span style=display:flex><span>  sq_start_value,
</span></span><span style=display:flex><span>  sq_increment_by,
</span></span><span style=display:flex><span>  sq_min_value,
</span></span><span style=display:flex><span>  sq_cache_value,
</span></span><span style=display:flex><span>  sq_is_cycled;</span></span></code></pre></div></div><p>To:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    max_value <span style=color:#ff79c6>AS</span> sq_max_value,
</span></span><span style=display:flex><span>    start_value <span style=color:#ff79c6>AS</span> sq_start_value,
</span></span><span style=display:flex><span>    increment_by <span style=color:#ff79c6>AS</span> sq_increment_by,
</span></span><span style=display:flex><span>    min_value <span style=color:#ff79c6>AS</span> sq_min_value,
</span></span><span style=display:flex><span>    cache_size <span style=color:#ff79c6>AS</span> sq_cache_value,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>CYCLE</span> <span style=color:#ff79c6>AS</span> sq_is_cycled
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_sequences
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    sequencename <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;microposts_id_seq&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> schemaname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;public&#39;</span>;</span></span></code></pre></div></div><p>Which gets us a nice little table:</p><p><div class=table-scroll></p><table><thead><tr><th class=align-right>sq_max_value</th><th class=align-right>sq_start_value</th><th class=align-right>sq_increment_by</th><th class=align-right>sq_min_value</th><th class=align-right>sq_cache_value</th><th>sq_is_cycled</th></tr></thead><tbody><tr><td class=align-right>9223372036854775807</td><td class=align-right>1</td><td class=align-right>1</td><td class=align-right>1</td><td class=align-right>1</td><td>f</td></tr></tbody></table><p></div>Now because of how <a href=https://www.postgresql.org/docs/current/sql-createsequence.html#id-1.9.3.81.6>SQL works</a>, we have to convert some data. So we translate the value <code>sq_is_cycled</code> from a boolean to a string.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>IF</span> sq_is_cycled <span style=color:#ff79c6>THEN</span>
</span></span><span style=display:flex><span>    sq_cycled :<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;CYCLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ELSE</span>
</span></span><span style=display:flex><span>    sq_cycled :<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;NO CYCLE&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;</span></span></code></pre></div></div><p>If we go to the table above, we can see that <code>sq_is_cycled</code> is false, which means <code>sq_cycled</code> is set to <code>'NO CYCLE'</code>.</p><blockquote class=not-prose><p>Note: because the code above requires variables, we can't run this outside of a function, so we just have to evaluate it inside our heads.</p></blockquote><p>So now we want to copy over the data from <code>public.microposts_id_seq</code> to <code>backup.microposts_id_seq</code></p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>ALTER</span> SEQUENCE backup.microposts_id_seq
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>INCREMENT</span> <span style=color:#ff79c6>BY</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>MINVALUE</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>MAXVALUE</span> <span style=color:#bd93f9>9223372036854775807</span> <span style=color:#ff79c6>START</span> <span style=color:#ff79c6>WITH</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>RESTART</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>CACHE</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>NO</span> <span style=color:#ff79c6>CYCLE</span>;</span></span></code></pre></div></div><p>Before we can go on, I need to talk about the elephant in the room.</p><blockquote class=not-prose><p>Heh, a little Postgres humour for everyone.</p></blockquote><p>We've just encountered a new piece of syntax, <code>ALTER</code>, which means that we're going to alter the definition of something. In the case above <a href=https://www.postgresql.org/docs/14/sql-altersequence.html>ALTER SEQUENCE</a> tells Postgres that we're about to alter the definition of the <code>backup.microposts_id_seq</code> definition.</p><p>Now, we can run the same select query to get data about a sequence to verify that we have successfully cloned <code>microposts_id_seq</code> into <code>backup</code></p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    max_value <span style=color:#ff79c6>AS</span> sq_max_value,
</span></span><span style=display:flex><span>    start_value <span style=color:#ff79c6>AS</span> sq_start_value,
</span></span><span style=display:flex><span>    increment_by <span style=color:#ff79c6>AS</span> sq_increment_by,
</span></span><span style=display:flex><span>    min_value <span style=color:#ff79c6>AS</span> sq_min_value,
</span></span><span style=display:flex><span>    cache_size <span style=color:#ff79c6>AS</span> sq_cache_value,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>CYCLE</span> <span style=color:#ff79c6>AS</span> sq_is_cycled
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_sequences
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    sequencename <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;microposts_id_seq&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> schemaname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;backup&#39;</span>;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>sq_max_value</th><th class=align-right>sq_start_value</th><th class=align-right>sq_increment_by</th><th class=align-right>sq_min_value</th><th class=align-right>sq_cache_value</th><th>sq_is_cycled</th></tr></thead><tbody><tr><td class=align-right>9223372036854775807</td><td class=align-right>1</td><td class=align-right>1</td><td class=align-right>1</td><td class=align-right>1</td><td>f</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-19 class=outline-4><h4 id=headline-19>4. Update sequence to match current values</h4><div id=outline-text-headline-19 class=outline-text-4><p>Then because we're cloning both meta information and the records themselves, we want to ensure our sequence values align with the <code>public</code>'s sequence values.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  seq_query :<span style=color:#ff79c6>=</span> format(<span style=color:#f1fa8c>&#39;SELECT last_value, log_cnt, is_called FROM %s.%s;&#39;</span>, source_schema, <span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> seq_query <span style=color:#ff79c6>INTO</span> sq_last_value,
</span></span><span style=display:flex><span>  sq_log_cnt,
</span></span><span style=display:flex><span>  sq_is_called;</span></span></code></pre></div></div><p>So, now we need to get the current state of the sequence for <code>microposts_id_seq</code>:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    last_value <span style=color:#ff79c6>AS</span> sq_last_value,
</span></span><span style=display:flex><span>    log_cnt <span style=color:#ff79c6>AS</span> sq_log_cnt,
</span></span><span style=display:flex><span>    is_called <span style=color:#ff79c6>AS</span> sq_is_called
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span>.microposts_id_seq;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>sq_last_value</th><th class=align-right>sq_log_cnt</th><th>sq_is_called</th></tr></thead><tbody><tr><td class=align-right>300</td><td class=align-right>30</td><td>t</td></tr></tbody></table><p></div>And update the <code>backup</code> schema</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;SELECT setval( &#39;&#39;&#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_last_value <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;, &#39;</span> <span style=color:#ff79c6>||</span> sq_is_called <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;);&#39;</span></span></span></code></pre></div></div><p>Which we can trivially translate to:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    setval(<span style=color:#f1fa8c>&#39;backup.microposts_id_seq&#39;</span>, <span style=color:#bd93f9>300</span>, <span style=color:#ff79c6>TRUE</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>setval</th></tr></thead><tbody><tr><td class=align-right>300</td></tr></tbody></table><p></div></p><div id=outline-container-headline-20 class=outline-5><h5 id=headline-20>Let's quickly verify our work</h5><div id=outline-text-headline-20 class=outline-text-5><p>If we call nextval on <code>public.microposts_id_seq</code> and <code>backup.microposts_id_seq</code> they should produce the same results.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    nextval(<span style=color:#f1fa8c>&#39;public.microposts_id_seq&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>nextval</th></tr></thead><tbody><tr><td class=align-right>301</td></tr></tbody></table><p></div></p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    nextval(<span style=color:#f1fa8c>&#39;backup.microposts_id_seq&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>nextval</th></tr></thead><tbody><tr><td class=align-right>301</td></tr></tbody></table><p></div>Now we just do that like… 50 more times.</p></div></div></div></div></div></div><div id=outline-container-headline-21 class=outline-3><h3 id=headline-21>Tables</h3><div id=outline-text-headline-21 class=outline-text-3><p>For step 3 of our 6 step plan, we need to copy tables. This includes their data and metadata. The section of the <code>clone_schema</code> function that deals with cloning tables is:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>TABLE_NAME</span>::<span style=color:#8be9fd;font-style:italic>text</span> 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.tables 
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> table_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;BASE TABLE&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      buffer :<span style=color:#ff79c6>=</span> dest_schema <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE TABLE &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; (LIKE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) 
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; INCLUDING ALL)&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>IF</span> include_recs 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>THEN</span> 
</span></span><span style=display:flex><span>        <span style=color:#6272a4>-- Insert records from source table
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;INSERT INTO &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; SELECT * FROM &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> <span style=color:#ff79c6>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FOR</span> column_, default_ <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>column_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>, 
</span></span><span style=display:flex><span>               <span style=color:#ff79c6>REPLACE</span>(column_default::<span style=color:#8be9fd;font-style:italic>text</span>, source_schema, dest_schema) 
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>FROM</span> information_schema.COLUMNS 
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> dest_schema 
</span></span><span style=display:flex><span>           <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>TABLE_NAME</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>object</span> 
</span></span><span style=display:flex><span>           <span style=color:#ff79c6>AND</span> column_default <span style=color:#ff79c6>LIKE</span> <span style=color:#f1fa8c>&#39;nextval(%&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(source_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;%::regclass)&#39;</span>
</span></span><span style=display:flex><span>      LOOP
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;ALTER TABLE &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ALTER COLUMN &#39;</span> <span style=color:#ff79c6>||</span> column_ <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; SET DEFAULT &#39;</span> <span style=color:#ff79c6>||</span> default_;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;</span></span></code></pre></div></div><p>Luckily, this section of the <code>clone_schema</code> function seems a lot simpler. Well, at least for me, but maybe that's because I am performing simple select or insert operations on tables any time I play in SQL.</p><div id=outline-container-headline-22 class=outline-4><h4 id=headline-22>Copying table structure and data</h4><div id=outline-text-headline-22 class=outline-text-4><p>Reading through the SQL above, we can see 4 main tasks ahead of us:</p><ol><li>Get all the data tables</li><li>Create the tables in the new schema</li><li>Copy data from the source schema's tables into the new schema's tables</li><li>Update Default/Sequence values for appropriate columns</li></ol></div></div><div id=outline-container-headline-23 class=outline-4><h4 id=headline-23>1. Get all tables</h4><div id=outline-text-headline-23 class=outline-text-4><p>We want to iterate over all the tables in a schema. But how do we get that information? Luckily, Postgres has meta-programming facilities based around schema's called <a href=https://www.postgresql.org/docs/current/information-schema.html>information_schema</a> which has a <a href=https://www.postgresql.org/docs/13/sql-createview.html>view</a> specifically for <a href=https://www.postgresql.org/docs/current/infoschema-tables.html>tables</a>.</p><p>We can get a list of all table names that are in the public schema, if we run the command below.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#6272a4>-- FOR OBJECT In
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>TABLE_NAME</span>::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    information_schema.tables
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    table_schema <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;public&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> table_type <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;BASE TABLE&#39;</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>table_name</th></tr></thead><tbody><tr><td>schema_migrations</td></tr><tr><td>ar_internal_metadata</td></tr><tr><td>active_storage_blobs</td></tr><tr><td>users</td></tr><tr><td>microposts</td></tr><tr><td>active_storage_attachments</td></tr><tr><td>active_storage_variant_records</td></tr><tr><td>relationships</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-24 class=outline-4><h4 id=headline-24>2. Copying table structure</h4><div id=outline-text-headline-24 class=outline-text-4><p>Like in sequences, we will step through copying one table as an example of how it works across the entire system. Let's operate on the <code>microposts</code> table.</p><p>I think you'll be surprised with how simple it is to copy table structures across schemas. When doing a CREATE table operation, we can interpret the following as "copy this table with X columns, indexes, and constraints." All we need are two new pieces of syntax: <a href=https://www.postgresql.org/docs/current/sql-createtable.html>LIKE and INCLUDING</a>.</p><blockquote class=not-prose><p>The LIKE clause specifies a table from which the new table automatically copies all column names, their data types, and their not-null constraints.</p><ul><li>Postgres Documentation</li></ul></blockquote><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>TABLE</span> backup.microposts (
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>LIKE</span> <span style=color:#ff79c6>public</span>.microposts <span style=color:#ff79c6>INCLUDING</span> <span style=color:#ff79c6>ALL</span>
</span></span><span style=display:flex><span>  );</span></span></code></pre></div></div><p>We can verify that this works by seeing that the table exists but is void of any data:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    id,
</span></span><span style=display:flex><span>    content
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    backup.microposts</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>id</th><th>content</th></tr></thead><tbody></tbody></table><p></div></p></div></div><div id=outline-container-headline-25 class=outline-4><h4 id=headline-25>3. Copy Data</h4><div id=outline-text-headline-25 class=outline-text-4><p>Copying data is one of the least complicated interactions we have. It's just a combination of INSERT and SELECT operations.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>INSERT</span> <span style=color:#ff79c6>INTO</span> backup.microposts
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span>.microposts;</span></span></code></pre></div></div><table><tbody><tr><td>INSERT 0 300</td></tr></tbody></table><p></div>We can admire our handiwork by using a SELECT and a <a href=https://www.postgresql.org/docs/14/queries-table-expressions.html>RIGHT JOIN</a> statement to compare the two tables.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span>.microposts.content <span style=color:#ff79c6>AS</span> public_content,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span>.microposts.id <span style=color:#ff79c6>AS</span> public_id,
</span></span><span style=display:flex><span>    backup.microposts.content <span style=color:#ff79c6>AS</span> backup_content,
</span></span><span style=display:flex><span>    backup.microposts.id <span style=color:#ff79c6>AS</span> backup_id
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    backup.microposts
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RIGHT</span> <span style=color:#ff79c6>JOIN</span> <span style=color:#ff79c6>public</span>.microposts <span style=color:#ff79c6>ON</span> backup.microposts.id <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>public</span>.microposts.id
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>LIMIT</span> <span style=color:#bd93f9>10</span>;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>public_content</th><th class=align-right>public_id</th><th>backup_content</th><th class=align-right>backup_id</th></tr></thead><tbody><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>1</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>1</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>2</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>2</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>3</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>3</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>4</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>4</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>5</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>5</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>6</td><td>Quisquam non ut aliquid repudiandae.</td><td class=align-right>6</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td class=align-right>7</td><td>Vitae quisquam facilis qui vel.</td><td class=align-right>7</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td class=align-right>8</td><td>Vitae quisquam facilis qui vel.</td><td class=align-right>8</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td class=align-right>9</td><td>Vitae quisquam facilis qui vel.</td><td class=align-right>9</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td class=align-right>10</td><td>Vitae quisquam facilis qui vel.</td><td class=align-right>10</td></tr></tbody></table><p></div></p><p>😲</p><p>Shocking, I know.</p></div></div><div id=outline-container-headline-26 class=outline-4><h4 id=headline-26>4. Update Default/Sequence values for columns</h4><div id=outline-text-headline-26 class=outline-text-4><p>When we created the <code>backup.microposts</code> table based off of the <code>public.microposts</code> table it copied everything, metadata included, word for word. However, this introduces a problem for us when we need to use our sequences from earlier. Our select statement copies and references <span style=text-decoration:underline>all of</span> the old table's metadata, including the sequences table reference. So, to fix this, we need to search through the table's metadata and look for columns with a default value that uses sequences and replaces the inner text from referencing <code>public</code> to reference <code>backup</code>.</p><p>We can generate a query that performs this for us.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>column_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>REPLACE</span>(column_default::<span style=color:#8be9fd;font-style:italic>text</span>, <span style=color:#f1fa8c>&#39;public&#39;</span>, <span style=color:#f1fa8c>&#39;backup&#39;</span>),
</span></span><span style=display:flex><span>    column_default::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    information_schema.COLUMNS
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    table_schema <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;backup&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>TABLE_NAME</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;microposts&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> column_default <span style=color:#ff79c6>LIKE</span> <span style=color:#f1fa8c>&#39;nextval(%public%::regclass)&#39;</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>column_name</th><th>replace</th><th>column_default</th></tr></thead><tbody></tbody></table><p></div>We will then use this information to update our apps table to reference the new sequences we generated.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>TABLE</span> backup.microposts
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ALTER</span> <span style=color:#ff79c6>COLUMN</span> id <span style=color:#ff79c6>SET</span> <span style=color:#ff79c6>DEFAULT</span> nextval(<span style=color:#f1fa8c>&#39;backup.microposts_id_seq&#39;</span>::regclass);</span></span></code></pre></div></div><p>If you are wondering what happens when we call <code>nextval('backup.microposts_id_seq'::regclass)</code>, you can play with it below.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    nextval(<span style=color:#f1fa8c>&#39;backup.microposts_id_seq&#39;</span>::regclass);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>nextval</th></tr></thead><tbody><tr><td class=align-right>301</td></tr></tbody></table><p></div>As you can see it generates a monotonically increasing number, perfect for an index or a record's id.</p></div></div></div></div><div id=outline-container-headline-27 class=outline-3><h3 id=headline-27>Foreign Key Constraints</h3><div id=outline-text-headline-27 class=outline-text-3><p>Now we're going to work on <a href=https://www.postgresql.org/docs/14/ddl-constraints.html#DDL-CONSTRAINTS-FK>foreign key constraints</a>. Foreign key constraints help validate constraints on relationships between tables.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>FOR</span> qry <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;ALTER TABLE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(dest_schema) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(rn.relname) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ADD CONSTRAINT &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(ct.conname) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#ff79c6>||</span> pg_get_constraintdef(ct.oid) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_constraint ct
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>JOIN</span> pg_class rn <span style=color:#ff79c6>ON</span> rn.oid <span style=color:#ff79c6>=</span> ct.conrelid
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    connamespace <span style=color:#ff79c6>=</span> src_oid
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> rn.relkind <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;r&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> ct.contype <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;f&#39;</span> LOOP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> qry;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span> LOOP;</span></span></code></pre></div></div><div id=outline-container-headline-28 class=outline-4><h4 id=headline-28>Copying Constraints</h4><div id=outline-text-headline-28 class=outline-text-4><p>Going by the code above we need to:</p><ol><li>Iterate over all constraints for a source schema</li><li>Dynamically generate queries that create the same constraints on the destination schema</li><li>Execute all of those queries</li></ol></div></div><div id=outline-container-headline-29 class=outline-4><h4 id=headline-29>0. Get src schema oid</h4><div id=outline-text-headline-29 class=outline-text-4><p>Throughout the following code samples, we need to get the <a href=https://www.postgresql.org/docs/current/datatype-oid.html>oid</a> of the source table. So, unlike our main function, we don't have access to that <code>oid</code> as a variable. To remedy this, we replace any reference to <code>src_oid</code> with the query to get the <code>oid</code> at run time.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    oid
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_namespace
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    nspname <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>);</span></span></code></pre></div></div></div></div><div id=outline-container-headline-30 class=outline-4><h4 id=headline-30>1. Get all constraints for source schema</h4><div id=outline-text-headline-30 class=outline-text-4><p>Postgres has a catalogue called <a href=https://www.postgresql.org/docs/current/catalog-pg-constraint.html>pg_constraint</a> that contains meta-information around all the constraints (foreign_key, primary_key, and exclusion) across the database. Unfortunately, that table is not sufficient to generate our query; we also need access to <a href=https://www.postgresql.org/docs/current/catalog-pg-class.html>pg_class</a> which is a catalogue that keeps meta-information on anything that has a column in Postgres.</p><p>In the <code>pg_constraint</code> catalogue it has a column called contype, that describes the type on constraint that the row describes. Ex:</p><ul><li>c = check constraint</li><li>f = foreign key constraint</li><li>p = primary key constraint</li><li>u = unique constraint</li><li>t = constraint trigger</li><li>x = exclusion constraint</li></ul><p>So because we're looking for foreign key constraints, we can limit our query to <code>ct.contype = 'f'</code>.</p><p>For the <code>pg_class</code> catalogue, it has a column called <code>relkind</code> that describes the kind of relations that row describes. Ex:</p><ul><li>r = ordinary table</li><li>i = index</li><li>S = sequence</li><li>t = TOAST table</li><li>v = view</li><li>m = materialized view</li><li>c = composite type</li><li>f = foreign table</li><li>p = partitioned table</li><li>I = partitioned index</li></ul><p>Because we've only really copied over ordinary tables, that's all we really care about for kinds of relation <code>rn.relkind = 'r'</code>.</p><p>Putting this all together, we'd get a query like:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    rn.relname,
</span></span><span style=display:flex><span>    ct.conname,
</span></span><span style=display:flex><span>    ct.oid
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_constraint ct
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>JOIN</span> pg_class rn <span style=color:#ff79c6>ON</span> rn.oid <span style=color:#ff79c6>=</span> ct.conrelid
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    connamespace <span style=color:#ff79c6>=</span> (
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>        oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>        pg_namespace
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>        nspname <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> rn.relkind <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;r&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> ct.contype <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;f&#39;</span>;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>relname</th><th>conname</th><th class=align-right>oid</th></tr></thead><tbody><tr><td>microposts</td><td>fk_rails_558c81314b</td><td class=align-right>16428</td></tr><tr><td>active_storage_attachments</td><td>fk_rails_c3b3935057</td><td class=align-right>16458</td></tr><tr><td>active_storage_variant_records</td><td>fk_rails_993965df05</td><td class=align-right>16476</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-31 class=outline-4><h4 id=headline-31>2. Generate a query to create constraints</h4><div id=outline-text-headline-31 class=outline-text-4><p>Postgres has a function, <a href=https://www.postgresql.org/docs/13/functions-info.html#FUNCTIONS-INFO-CATALOG-TABLE>pg_get_constraintdef</a>, that can generate a constraint definition based on an object id.</p><p>For example, I took a row from the constraints query above and got an OID of <code>16428</code>.</p><p><div class=table-scroll></p><table><thead><tr><th>relname</th><th>conname</th><th class=align-right>oid</th></tr></thead><tbody><tr><td>microposts</td><td>fk_rails_d296c622dc</td><td class=align-right>16428</td></tr></tbody></table><p></div></p><p>If we run a select statement on that function…</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> pg_get_constraintdef(<span style=color:#bd93f9>16428</span>)</span></span></code></pre></div></div><p>We get the following definition:</p><p><div class=table-scroll></p><table><thead><tr><th>pg_get_constraintdef</th></tr></thead><tbody><tr><td>FOREIGN KEY (user_id) REFERENCES users(id)</td></tr></tbody></table><p></div></p><p>We can then put this information with the <code>constraints query</code> to generate the query for us:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#39;ALTER TABLE &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#f1fa8c>&#39;backup&#39;</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(rn.relname) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; ADD CONSTRAINT &#39;</span> <span style=color:#ff79c6>||</span> quote_ident(ct.conname) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#ff79c6>||</span> pg_get_constraintdef(ct.oid) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>    pg_constraint ct
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>JOIN</span> pg_class rn <span style=color:#ff79c6>ON</span> rn.oid <span style=color:#ff79c6>=</span> ct.conrelid
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>    connamespace <span style=color:#ff79c6>=</span> (
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>        oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>        pg_namespace
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>        nspname <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> rn.relkind <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;r&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>AND</span> ct.contype <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;f&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>LIMIT</span> <span style=color:#bd93f9>1</span>;</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>?column?</th></tr></thead><tbody><tr><td>ALTER TABLE backup.microposts ADD CONSTRAINT fk_rails_558c81314b FOREIGN KEY (user_id) REFERENCES users(id);</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-32 class=outline-4><h4 id=headline-32>3. Execute generate queries</h4><div id=outline-text-headline-32 class=outline-text-4><p>Now, we can use a select statement to run a string as a query</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>SELECT</span> <span style=color:#f1fa8c>&#39;ALTER TABLE backup.active_storage_attachments ADD CONSTRAINT fk_rails_d296c622dc FOREIGN KEY (blob_id) REFERENCES active_storage_blobs(id);&#39;</span></span></span></code></pre></div></div><p>Finally, just do that for all foreign keys we need to update. I'll wait ⏰</p></div></div></div></div><div id=outline-container-headline-33 class=outline-3><h3 id=headline-33>Views</h3><div id=outline-text-headline-33 class=outline-text-3><p>In step 5, we will copy all of the views defined in the source schema into the destination schema. If you are new to the "advanced" SQL concept of a <a href=https://www.postgresql.org/docs/14/tutorial-views.html>view</a>; it is a way of naming a query that you expect to be running over and over again.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#ff79c6>FOR</span> <span style=color:#ff79c6>object</span> <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>table_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP
</span></span><span style=display:flex><span>      buffer :<span style=color:#ff79c6>=</span> dest_schema <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> view_definition <span style=color:#ff79c6>INTO</span> v_def
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(source_schema)
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>table_name</span> <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#ff79c6>object</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE OR REPLACE VIEW &#39;</span> <span style=color:#ff79c6>||</span> buffer <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; AS &#39;</span> <span style=color:#ff79c6>||</span> v_def <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span> ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;</span></span></code></pre></div></div><p>If you have a database with views, the steps would be as follow:</p><ol><li>Collect views from <code>information_schema.views</code></li><li>Use the view definition that is stored in the view catalogue to define the view in the destination schema</li></ol><p>Aye, but there's the rub. Our data set is basic and doesn't include views or functions. So we'll build some as we go.</p><div id=outline-container-headline-34 class=outline-4><h4 id=headline-34>0. Precursor</h4><div id=outline-text-headline-34 class=outline-text-4><p>But before we can do that let's be absolutely sure that we don't have any views stored in our view catalog.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>       <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>table_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>)</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>table_name</th></tr></thead><tbody></tbody></table><p></div></p><div id=outline-container-headline-35 class=outline-5><h5 id=headline-35>Creating our view</h5><div id=outline-text-headline-35 class=outline-text-5><p>In our example, we'll create a simple view that finds all the microposts created by a particular user.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>VIEW</span> first_users_posts <span style=color:#ff79c6>AS</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>SELECT</span> content, microposts.created_at <span style=color:#ff79c6>as</span> created_at, name
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> microposts, users
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>WHERE</span> users.id <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>SELECT</span> id <span style=color:#ff79c6>FROM</span> users <span style=color:#ff79c6>LIMIT</span> <span style=color:#bd93f9>1</span>)</span></span></code></pre></div></div><p>Now, lets validate that it works</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>FROM</span> first_users_posts <span style=color:#ff79c6>LIMIT</span> <span style=color:#bd93f9>10</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>content</th><th>created_at</th><th>name</th></tr></thead><tbody><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.07503</td><td>Example User</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.085981</td><td>Example User</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.093539</td><td>Example User</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.099877</td><td>Example User</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.106309</td><td>Example User</td></tr><tr><td>Quisquam non ut aliquid repudiandae.</td><td>2021-12-15 05:17:48.112993</td><td>Example User</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td>2021-12-15 05:17:48.119943</td><td>Example User</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td>2021-12-15 05:17:48.126818</td><td>Example User</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td>2021-12-15 05:17:48.133882</td><td>Example User</td></tr><tr><td>Vitae quisquam facilis qui vel.</td><td>2021-12-15 05:17:48.140942</td><td>Example User</td></tr></tbody></table><p></div></p></div></div></div></div><div id=outline-container-headline-36 class=outline-4><h4 id=headline-36>1. Collecting the views</h4><div id=outline-text-headline-36 class=outline-text-4><p>With all the dirty work done, we need to loop over all of the views in our catalogue. Luckily we've already seen the primary tool for that. Again, we'll be limiting our selection to one, so it's easier to follow along and go through this step by step.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>       <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>table_name</span>::<span style=color:#8be9fd;font-style:italic>text</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>)
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>LIMIT</span> <span style=color:#bd93f9>1</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>table_name</th></tr></thead><tbody><tr><td>first_users_posts</td></tr></tbody></table><p></div></p></div></div><div id=outline-container-headline-37 class=outline-4><h4 id=headline-37>2. Copying views</h4><div id=outline-text-headline-37 class=outline-text-4><p>Great, we've got a view name. Now we can use that name to build up the name of the view for the destination scheme:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> <span style=color:#f1fa8c>&#39;backup&#39;</span> <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#f1fa8c>&#39;first_users_posts&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>?column?</th></tr></thead><tbody><tr><td>backup.first_users_posts</td></tr></tbody></table><p></div>Now that we've generated the name, we need to get the view definition:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> view_definition
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> information_schema.views
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> table_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>)
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>table_name</span> <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;first_users_posts&#39;</span>);</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th>view_definition</th></tr></thead><tbody><tr><td>SELECT microposts.content,</td></tr><tr><td>microposts.created_at,</td></tr><tr><td>users.name</td></tr><tr><td>FROM microposts,</td></tr><tr><td>users</td></tr><tr><td>WHERE (users.id = ( SELECT users_1.id</td></tr><tr><td>FROM users users_1</td></tr><tr><td>LIMIT 1));</td></tr></tbody></table><p></div>And then, finally, we can use these pieces of information to copy the view.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>DO</span> $$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#f1fa8c>&#39;CREATE OR REPLACE VIEW &#39;</span> <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;backup&#39;</span> <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;.&#39;</span> <span style=color:#ff79c6>||</span> quote_ident(<span style=color:#f1fa8c>&#39;first_users_posts&#39;</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39; AS &#39;</span> <span style=color:#ff79c6>||</span> (
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>        view_definition
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span>
</span></span><span style=display:flex><span>        information_schema.views
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>WHERE</span>
</span></span><span style=display:flex><span>        table_schema <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;public&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>AND</span> <span style=color:#ff79c6>table_name</span> <span style=color:#ff79c6>=</span> quote_ident(<span style=color:#f1fa8c>&#39;first_users_posts&#39;</span>)) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;;&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span>
</span></span><span style=display:flex><span>  $$;</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-38 class=outline-3><h3 id=headline-38>Functions</h3><div id=outline-text-headline-38 class=outline-text-3><p>And this is where we are going to get <code>Meta</code>. We will talk about a cloning function while dissecting our cloning function.</p><blockquote class=not-prose><p>For those reading this, not in 2022, Facebook recently changed their name to Meta, so I wanted to make a bad pun. But instead of you being able to chuckle at that, you now have to read this long-winded explanation.</p></blockquote><p>The final part of the clone schema function is:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#ff79c6>FOR</span> func_oid <span style=color:#ff79c6>IN</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> oid
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_proc 
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>WHERE</span> pronamespace <span style=color:#ff79c6>=</span> src_oid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    LOOP      
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> pg_get_functiondef(func_oid) <span style=color:#ff79c6>INTO</span> qry;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>replace</span>(qry, source_schema, dest_schema) <span style=color:#ff79c6>INTO</span> dest_qry;
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>EXECUTE</span> dest_qry;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>END</span> LOOP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>RETURN</span>;</span></span></code></pre></div></div><div id=outline-container-headline-39 class=outline-4><h4 id=headline-39>Generating a list of functions</h4><div id=outline-text-headline-39 class=outline-text-4><p>We need at least one function to clone, so why not add the function that this article is about? You <span style=text-decoration:underline>could</span> scroll all the way back to the page, copy and paste it in your psql or pgAdmin or whatever you're using to follow along… or you could do what the <del>un</del> cool kids are doing and evaluate the following expression in your Emacs.</p><div class="src src-emacs-lisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>org-sbe</span> <span style=color:#8be9fd;font-style:italic>clone_schema_func</span>)</span></span></code></pre></div></div><p>Now, we can search for all functions in our current schema:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> oid, proname, pronamespace
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_proc
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>WHERE</span> proname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;clone_schema&#39;</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>oid</th><th>proname</th><th class=align-right>pronamespace</th></tr></thead><tbody><tr><td class=align-right>16675</td><td>clone_schema</td><td class=align-right>2200</td></tr></tbody></table><p></div>We can do the same as our base query by getting the object id of our current schema…</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> oid
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;public&#39;</span></span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>oid</th></tr></thead><tbody><tr><td class=align-right>2200</td></tr></tbody></table><p></div>and to put that together</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> oid, proname, pronamespace
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_proc
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>WHERE</span> pronamespace <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>SELECT</span> oid
</span></span><span style=display:flex><span>                              <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>                              <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;public&#39;</span>)</span></span></code></pre></div></div><p><div class=table-scroll></p><table><thead><tr><th class=align-right>oid</th><th>proname</th><th class=align-right>pronamespace</th></tr></thead><tbody><tr><td class=align-right>16497</td><td>check_existence</td><td class=align-right>2200</td></tr><tr><td class=align-right>16675</td><td>clone_schema</td><td class=align-right>2200</td></tr></tbody></table><p></div></p><blockquote class=not-prose><p>Wouldn't this be a lot easier when we're inside a function and have access to variables? Oh, and we have loops?</p></blockquote></div></div><div id=outline-container-headline-40 class=outline-4><h4 id=headline-40>Copying Functions</h4><div id=outline-text-headline-40 class=outline-text-4><p>Now that we have ensured we have data to play with, now we need to:</p><ol><li>Get all function definitions</li><li>Replace every reference to source_schema with dest_schema within those functions</li><li>Execute all function definitions as queries.</li></ol></div></div><div id=outline-container-headline-41 class=outline-4><h4 id=headline-41>1. Get a function definition</h4><div id=outline-text-headline-41 class=outline-text-4><p>Get a function defition from a func_oid</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> pg_get_functiondef(<span style=color:#bd93f9>16675</span>);</span></span></code></pre></div></div><blockquote class=not-prose><p>This section omitted for brevity. But it's the definition for <code>clone_schema</code></p></blockquote></div></div><div id=outline-container-headline-42 class=outline-4><h4 id=headline-42>2. Replace schema name</h4><div id=outline-text-headline-42 class=outline-text-4><p>Use the <a href=https://www.postgresql.org/docs/14/functions-string.html>replace</a> function to change any reference to the schema names</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff79c6>SELECT</span> <span style=color:#ff79c6>replace</span>((<span style=color:#ff79c6>SELECT</span> pg_get_functiondef(<span style=color:#bd93f9>16675</span>)), <span style=color:#f1fa8c>&#39;public&#39;</span>, <span style=color:#f1fa8c>&#39;backup&#39;</span>);</span></span></code></pre></div></div><blockquote class=not-prose><p>This section omitted for brevity.</p></blockquote></div></div><div id=outline-container-headline-43 class=outline-4><h4 id=headline-43>3. Add the new function definition</h4><div id=outline-text-headline-43 class=outline-text-4><p>Now we need to do a little bit of magic and wrap our Execute call in an anonymous function to ensure it runs.</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#ff79c6>DO</span> $$
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>BEGIN</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>EXECUTE</span> <span style=color:#ff79c6>replace</span>((
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span>
</span></span><span style=display:flex><span>        pg_get_functiondef(<span style=color:#bd93f9>16675</span>)), <span style=color:#f1fa8c>&#39;public&#39;</span>, <span style=color:#f1fa8c>&#39;backup&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>END</span>$$</span></span></code></pre></div></div><p>Then, we can validate our work by searching for this cloned function in the new schema:</p><div class="src src-sql"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>      <span style=color:#ff79c6>SELECT</span> oid, proname, pronamespace
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>FROM</span> pg_proc
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>WHERE</span> pronamespace <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>SELECT</span> oid
</span></span><span style=display:flex><span>                              <span style=color:#ff79c6>FROM</span> pg_namespace
</span></span><span style=display:flex><span>                              <span style=color:#ff79c6>WHERE</span> nspname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;backup&#39;</span>)</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-44 class=outline-3><h3 id=headline-44>Fin</h3><div id=outline-text-headline-44 class=outline-text-3><p>And that, in essence, is how you copy one schema into the next. I think that was pretty simple… you know, once it's been broken down into a bunch of small readable chunks that you can easily play with.</p></div></div></div></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>Why log_cnt exists is kind of interesting. <a href=https://stackoverflow.com/a/66458412>https://stackoverflow.com/a/66458412</a></p></div></div><div class=footnote-definition><sup id=footnote-2><a href=#footnote-reference-2>2</a></sup><div class=footnote-body><p>is_called is boolean that modifies what setval returns. <a href=https://www.postgresql.org/docs/14/functions-sequence.html>https://www.postgresql.org/docs/14/functions-sequence.html</a></p><script>const expand=()=>{const e=document.getElementById("full-code"),t=document.getElementById("partial-code"),n=document.getElementById("collapse"),s=document.getElementById("expand");e.className="",t.className="hidden",s.className="hidden",n.className=""},collapse=()=>{const e=document.getElementById("full-code"),t=document.getElementById("partial-code"),n=document.getElementById("collapse"),s=document.getElementById("expand");e.className="hidden",t.className="",s.className="",n.className="hidden"}</script></div></div></div></div></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2024
Justin Barclay
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>