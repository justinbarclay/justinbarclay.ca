<!doctype html><html lang=en><head><title>Sharpening Your Toolshed: git-sync with a little polish · Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="Add a bit of polish to git-sync"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sharpening Your Toolshed: git-sync with a little polish"><meta name=twitter:description content="Add a bit of polish to git-sync"><meta property="og:title" content="Sharpening Your Toolshed: git-sync with a little polish"><meta property="og:description" content="Add a bit of polish to git-sync"><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/automating-git-sync-part-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-12T00:00:00+00:00"><meta property="og:see_also" content="https://justinbarclay.ca/posts/sanding-down-git-sync/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/automating-git-sync/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/sharpening-your-toolshed/"><link rel=canonical href=https://justinbarclay.ca/posts/automating-git-sync-part-2/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/automating-git-sync-part-2/>Sharpening Your Toolshed: git-sync with a little polish</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-11-12T00:00:00Z>November 12, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div></div></header><div class=post-content><p><div class=banner-image></p><p alt='"Two programmers putting a shine on their recently sharpened toolshed toolshed."'><img src=/images/sharpening-your-toolshed-part-2.webp></p><p></div></p><p>When last I left off with <a href=/posts/automating-git-sync>git-sync</a>, I had written a minor mode that runs git-sync every time a file is saved.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-after-save</span> ()
</span></span><span style=display:flex><span>   (<span style=color:#8be9fd;font-style:italic>async-shell-command</span> <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>define-minor-mode</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A minor mode for running git-sync upon saving.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:lighter</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>                    (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> <span style=color:#f1fa8c>&#39;git-sync-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))))</span></span></code></pre></div></div><p>However, this minor mode comes with two inconveniences:</p><ol><li>It can only be customized using <code>.dir-locals</code>.</li><li>An annoying buffer pops up every time a file is saved.</li><li>It runs only on *Nix environments</li><li>I can't count.</li></ol><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Creating a Global Minor Mode</h2><div id=outline-text-headline-1 class=outline-text-2><p>The first issue is relatively simple to address. Instead of relying on a <code class=verbatim>.dir-locals.el</code> file to determine when git-sync should run. Instead, I can transform it into a <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Defining-Minor-Modes.html#index-define_002dglobalized_002dminor_002dmode>global minor mode</a> by employing the <code class=verbatim>define-global-minor-mode</code> macro.</p><blockquote><p>[define-global-minor-mode] defines a global toggle named global-mode, whose meaning is to enable or disable the buffer-local minor mode in all … buffers. It also executes the body forms. To turn on the minor mode in a buffer, it uses the function turn-on; to turn off the minor mode, it calls mode with −1 as an argument.</p><ul><li>Gnu Emacs</li></ul></blockquote><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>define-global-minor-mode</span> <span style=color:#8be9fd;font-style:italic>global-git-sync-mode</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:turn-on</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> () (<span style=color:#8be9fd;font-style:italic>git-sync-mode</span> <span style=color:#bd93f9>1</span>))</span></span></code></pre></div></div><p>I want <code>git-sync-mode</code> to run in specific files and directories. However, doing this makes git-sync run globally in all files, and I've already decided I don't want this. To run it selectively, I need to create a different minor mode and utilize the <code class=verbatim>:global</code> option:</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>define-minor-mode</span> <span style=color:#8be9fd;font-style:italic>git-sync-global-mode</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#34;A global minor mode for running git-sync.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:lighter</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:global</span> <span style=color:#f1fa8c>&#39;t</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>                  (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> <span style=color:#f1fa8c>&#39;git-sync-after-save-hook</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync-after-save-hook</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>)))</span></span></code></pre></div></div><p>The final step involves creating a new hook that looks at a user-customized list, <a href=https://www.gnu.org/software/emacs/manual/html_node/eintr/defcustom.html><code>defcustom</code></a>, and only runs git-sync if it's within one of the specified directories.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> nil
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#34;List of directories to sync with git-sync.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:safe</span> <span style=color:#50fa7b>#&#39;listp</span>)</span></span></code></pre></div></div><p>Then, make a new <code>after-save-hook</code>, <code>git-sync-global-after-save</code>, which checks if the saved file exists in one of the allowed directories or its subdirectory.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--allowed-directory</span> (<span style=color:#8be9fd;font-style:italic>current-file</span> <span style=color:#8be9fd;font-style:italic>allowed-dirs</span>)
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Return t if CURRENT-FILE is in one of the ALLOWED-SUBDIRS.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>cl-reduce</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>any-p</span> <span style=color:#8be9fd;font-style:italic>allowed-dir</span>)
</span></span><span style=display:flex><span>                 (<span style=color:#8be9fd;font-style:italic>or</span> <span style=color:#8be9fd;font-style:italic>any-p</span>
</span></span><span style=display:flex><span>                     (<span style=color:#8be9fd;font-style:italic>string-prefix-p</span> <span style=color:#8be9fd;font-style:italic>allowed-dir</span> <span style=color:#8be9fd;font-style:italic>current-file</span>)))
</span></span><span style=display:flex><span>               <span style=color:#8be9fd;font-style:italic>allowed-dirs</span>
</span></span><span style=display:flex><span>               <span style=color:#8be9fd;font-style:italic>:initial-value</span> nil))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-global-after-save</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>when</span> (<span style=color:#8be9fd;font-style:italic>git-sync--allowed-subdirectory</span> (<span style=color:#50fa7b>buffer-file-name</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>async-shell-command</span> <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>)))</span></span></code></pre></div></div><p>Now, set <code class=verbatim>git-sync-global-mode</code> as follows</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>define-minor-mode</span> <span style=color:#8be9fd;font-style:italic>git-sync-global-mode</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>&#34;A global minor mode for running git-sync.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:lighter</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:global</span> <span style=color:#f1fa8c>&#39;t</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>git-sync-global-mode</span>
</span></span><span style=display:flex><span>                  (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> <span style=color:#f1fa8c>&#39;git-sync-global-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync-global-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>)))</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>Shifting from a Command to a Process</h2><div id=outline-text-headline-2 class=outline-text-2><p>While <code class=verbatim>async-shell-command</code> is a good start for executing external programs in Emacs, it has some limitations when used programmatically. It opens up a buffer alongside your workspace, shrinking your workspace in half, and it's not easily closed by switching to the buffer and pressing 'q'. You're left with using something like <code>C-x k</code> to kill the buffer, like a barbarian.</p><video src=/images/git-sync-example.webm title=/images/git-sync-example.webm max-width=800px width=100% type='"video/webm"' controls>/images/git-sync-example.webm</video><p>Instead, I'm going to use the <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Asynchronous-Processes.html#index-make_002dprocess><code class=verbatim>make-process</code></a> function to give me more control over the environment in which <code>git-sync</code> is run. <code class=verbatim>make-process</code> takes a lot arguments (<code class=verbatim>name</code>, <code class=verbatim>buffer</code>, <code class=verbatim>command</code>, <code class=verbatim>coding</code>, <code class=verbatim>noquery</code>, <code class=verbatim>stop</code>, <code class=verbatim>connection-type</code>, <code class=verbatim>filter</code>, <code class=verbatim>sentinel</code>, <code class=verbatim>stderr</code>, <code class=verbatim>file-handler</code>) but I'm only concerned with four:</p><ul><li><code class=verbatim>name</code>
NAME is name for process. It is modified if necessary to make it unique.</li><li><code class=verbatim>sentinel</code>
Install SENTINEL as the process sentinel.</li><li><code class=verbatim>buffer</code>
BUFFER is the buffer (or buffer-name) to associate with the process. Process output goes at end of that buffer, unless you specify a filter function to handle the output. BUFFER may be also nil, meaning that this process is not associated with any buffer.</li><li><code class=verbatim>command</code>
COMMAND is a list starting with the program file name, followed by strings to give to the program as arguments. If the program file name is not an absolute file name, 'make-process' will look for the program file name in 'exec-path' (which is a list of directories).</li></ul><p>The most interesting part is the <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Sentinels.html>process sentinel</a>.</p><blockquote><p>A process sentinel is a function that is called whenever the associated process changes status for any reason, including signals (whether sent by Emacs or caused by the process's own actions) that terminate, stop, or continue the process.</p><p>…</p><p>The sentinel receives two arguments: the process for which the event occurred and a string describing the type of event.</p><ul><li>Gnu Emacs</li></ul></blockquote><p>So, a process sentinel could look like this</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>when</span> (<span style=color:#8be9fd;font-style:italic>string=</span> <span style=color:#8be9fd;font-style:italic>event</span> <span style=color:#f1fa8c>&#34;finished\n&#34;</span>)
</span></span><span style=display:flex><span>      (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;Process finished&#34;</span> <span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)))</span></span></code></pre></div></div><p>The process sentinel is a function that can respond to events in a process buffer. What I want to do with the sentinel function is to make the process buffer read-only for the user and have the user quit the buffer (<a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Quitting-Windows.html#index-quit_002drestore_002dwindow>bury it</a>) when they press <code class=verbatim>q</code>.</p><p>Luckily, there is a special <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Major-Modes.html>major-mode</a> called <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Basic-Major-Modes.html#index-special_002dmode>special-mode</a> that does just that.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    <span style=color:#6272a4>;; with-current-buffer remembers the current buffer while</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>;; executing the body in another buffer</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>special-mode</span>)))</span></span></code></pre></div></div><blockquote><p>Emacs can only ever operate in one buffer at a time, so I use <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Current-Buffer.html#index-with_002dcurrent_002dbuffer><code>with-current-buffer</code></a> as means to remember what the current buffer is, switch to a buffer that I want to operate in, and then return control back to the <code>current-buffer</code> when I'm done my work.</p></blockquote><p>Now that I have <code class=verbatim>git-sync--sentinel-fn</code>, my next step is to create a buffer for Emacs to run the <code class=verbatim>git-sync</code> process in. I can use <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Creating-Buffers.html#index-get_002dbuffer_002dcreate>get-buffer-create</a> to find the <code class=verbatim>*git-sync*</code> buffer, otherwise create one with that name.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)</span></span></code></pre></div></div><blockquote><p>By convention, if a buffer's name is surrounded by asterisks (<code>*</code>), that buffer is not associated with a file.</p></blockquote><p>With that information, I can make a process</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git-sync&#34;</span> <span style=color:#f1fa8c>&#34;-n&#34;</span> <span style=color:#f1fa8c>&#34;-s&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#f1fa8c>&#39;git-sync--sentinel-fn</span>)</span></span></code></pre></div></div><p>Putting it all together, I can get the full minor-mode</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> nil
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;List of directories to sync with git-sync.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:safe</span> <span style=color:#50fa7b>#&#39;listp</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>special-mode</span>))) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git-sync&#34;</span> <span style=color:#f1fa8c>&#34;-n&#34;</span> <span style=color:#f1fa8c>&#34;-s&#34;</span>)
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#f1fa8c>&#39;git-sync--sentinel-fn</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--allowed-directory</span> (<span style=color:#8be9fd;font-style:italic>current-file</span> <span style=color:#8be9fd;font-style:italic>allowed-dirs</span>)
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Return t if CURRENT-FILE is in one of the ALLOWED-SUBDIRS.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>cl-reduce</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>any-p</span> <span style=color:#8be9fd;font-style:italic>allowed-dir</span>)
</span></span><span style=display:flex><span>                 (<span style=color:#8be9fd;font-style:italic>or</span> <span style=color:#8be9fd;font-style:italic>any-p</span>
</span></span><span style=display:flex><span>                     (<span style=color:#8be9fd;font-style:italic>string-prefix-p</span> <span style=color:#8be9fd;font-style:italic>allowed-dir</span> <span style=color:#8be9fd;font-style:italic>current-file</span>)))
</span></span><span style=display:flex><span>               <span style=color:#8be9fd;font-style:italic>allowed-dirs</span>
</span></span><span style=display:flex><span>               <span style=color:#8be9fd;font-style:italic>:initial-value</span> nil))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--global-after-save</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>when</span> (<span style=color:#8be9fd;font-style:italic>git-sync--allowed-subdirectory</span> (<span style=color:#50fa7b>buffer-file-name</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>git-sync--execute</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>define-minor-mode</span> <span style=color:#8be9fd;font-style:italic>git-sync-global-mode</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>;; Add minor mode documentation here</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A global minor mode to run git-sync.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:lighter</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:global</span> <span style=color:#f1fa8c>&#39;t</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>                    (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> <span style=color:#f1fa8c>&#39;git-sync--global-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync--global-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))))</span></span></code></pre></div></div><p>Now, I can admire the fruits of my labour. I can run <code class=verbatim>git-sync</code> in my diary after every save, and then I can obsessively open up the <code class=verbatim>*git-sync*</code> buffer to ensure it's working.</p><video src=/images/git-sync-example-2.webm title=/images/git-sync-example-2.webm max-width=800px width=100% type='"video/webm"' controls>/images/git-sync-example-2.webm</video><p>Finally, I've got git-sync-mode to a state where using it no longer annoys me.</p></div></div></div><footer><section class=see-also><h3 id=see-also-in-sharpening-your-toolshed>See also in sharpening-your-toolshed
<a class=heading-link href=#see-also-in-sharpening-your-toolshed><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><nav><ul><li><a href=/posts/sanding-down-git-sync/>Sharpening Your Toolshed: Sanding down the rough edges of git-sync</a></li><li><a href=/posts/automating-git-sync/>Sharpening Your Toolshed: Automating git-sync</a></li><li><a href=/posts/sharpening-your-toolshed/>Sharpening Your Toolshed</a></li></ul></nav></section></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2024
Justin Barclay
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>