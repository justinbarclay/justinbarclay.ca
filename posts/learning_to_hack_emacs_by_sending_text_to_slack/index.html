<!doctype html><html lang=en><head><title>Hacking Emacs to send text to Slack Â· Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="Introduction Link to heading I want to get Emacs to send snippets of text from any buffer to Slack. Luckily, there is a Slack client for Emacs called emacs-slack. So, most of the hard work is done for me &mdash; I have an interface to Slack in Emacs that allows me to send and read messages in any channel, room, or direct message. Unfortunately, I am now at an uncanny valley."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hacking Emacs to send text to Slack"><meta name=twitter:description content="Introduction Link to heading I want to get Emacs to send snippets of text from any buffer to Slack. Luckily, there is a Slack client for Emacs called emacs-slack. So, most of the hard work is done for me &mdash; I have an interface to Slack in Emacs that allows me to send and read messages in any channel, room, or direct message. Unfortunately, I am now at an uncanny valley."><meta property="og:title" content="Hacking Emacs to send text to Slack"><meta property="og:description" content="Introduction Link to heading I want to get Emacs to send snippets of text from any buffer to Slack. Luckily, there is a Slack client for Emacs called emacs-slack. So, most of the hard work is done for me &mdash; I have an interface to Slack in Emacs that allows me to send and read messages in any channel, room, or direct message. Unfortunately, I am now at an uncanny valley."><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/learning_to_hack_emacs_by_sending_text_to_slack/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-03-03T00:00:00-07:00"><meta property="article:modified_time" content="2019-02-03T15:43:06-07:00"><link rel=canonical href=https://justinbarclay.ca/posts/learning_to_hack_emacs_by_sending_text_to_slack/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/learning_to_hack_emacs_by_sending_text_to_slack/>Hacking Emacs to send text to Slack</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2018-03-03T00:00:00-07:00>March 3, 2018
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
10-minute read</span></div></div></header><div class=post-content><h2 id=introduction>Introduction
<a class=heading-link href=#introduction><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I want to get Emacs to send snippets of text from any buffer to Slack. Luckily, there is a Slack client for Emacs called <a href=https://github.com/yuya373/emacs-slack>emacs-slack</a>. So, most of the hard work is done for me &mdash; I have an interface to Slack in Emacs that allows me to send and read messages in any channel, room, or direct message. Unfortunately, I am now at an uncanny valley. I think emacs-slack does a lot of things right, but I don&rsquo;t think it makes sharing as easy as it should be.</p><h3 id=why>Why?
<a class=heading-link href=#why><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Why do I use Emacs? Mostly because I like to break things, and it is very easy for me to break my Emacs set-up.</p><p><em>No, why&mldr;</em></p><p>Why do I use Slack inside of Emacs? I like my Slack like I like my Emacs: brittle and glued together with arcane magic I don&rsquo;t understand. There is also the side benefit that Slack in Emacs takes up fewer resources than the Slack desktop app.</p><p><em>No! Why isn&rsquo;t emacs-slack good enough?</em></p><p>Oh, well, because I am a developer and I like to share things, and I am lazy &mdash; too lazy to copy and paste every time I want to share an idea or have a question about a line of code. So instead of copying and pasting, I plan on spending way too long reading someone else&rsquo;s code, figuring out how to make sharing code with my team easier.</p><p>You, uh, don&rsquo;t wanna go for a ride do you?</p><figure><img src=/images/carpet-ride.png></figure><h3 id=tl-dr>TL;DR
<a class=heading-link href=#tl-dr><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Install <a href=https://github.com/yuya373/emacs-slack>emacs-slack</a> and paste the code below into your init file to be able to send a snippet of code to Slack.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>jb/send-region-to-slack-code</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>team</span> (<span style=color:#8be9fd;font-style:italic>slack-team-select</span>)) <span style=color:#6272a4>;; Select team</span>
</span></span><span style=display:flex><span>        (<span style=color:#8be9fd;font-style:italic>room</span> (<span style=color:#8be9fd;font-style:italic>slack-room-select</span>
</span></span><span style=display:flex><span>               (<span style=color:#8be9fd;font-style:italic>cl-loop</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>in</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>                        <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>channels</span> <span style=color:#50fa7b>=</span> (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>channels</span>)
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>nconc</span> <span style=color:#8be9fd;font-style:italic>channels</span>)))) <span style=color:#6272a4>;; Get all rooms from selected team</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>slack-message-send-internal</span> (<span style=color:#50fa7b>concat</span> <span style=color:#f1fa8c>&#34;```&#34;</span>(<span style=color:#8be9fd;font-style:italic>filter-buffer-substring</span> (<span style=color:#50fa7b>region-beginning</span>) (<span style=color:#50fa7b>region-end</span>)) <span style=color:#f1fa8c>&#34;```&#34;</span>)
</span></span><span style=display:flex><span>                                 (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>room</span> <span style=color:#8be9fd;font-style:italic>id</span>)
</span></span><span style=display:flex><span>                                 <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span></code></pre></div><h2 id=let-s-play>Let&rsquo;s play!
<a class=heading-link href=#let-s-play><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>If you wish to follow along, you will need to install and set up <a href=https://github.com/yuya373/emacs-slack>emacs-slack.</a></p><h3 id=install>Install
<a class=heading-link href=#install><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>If you use <a href=https://github.com/jwiegley/use-package>use-package</a> as your Emacs package manager, <a href=https://github.com/yuya373>Yuya373</a> has some code in the emacs-slack repo that you can just <a href=https://github.com/yuya373/emacs-slack#configure>copy and paste</a> into your init file.</p><p>If you don&rsquo;t use use-package, you could use <a href=https://github.com/emacscollective/borg>borg</a> to assimilate the package into your Emacs.</p><p>If you don&rsquo;t use borg, you could use <a href=https://github.com/dimitri/el-get>el-get</a> to install the packages for you.</p><p>If you don&rsquo;t have any of these, a nice simple <em>M-x package-install emacs-slack</em> works wonders.</p><p>If you don&rsquo;t want to do any of this, you could give up on the good life and use vim.</p><h3 id=setup>Setup
<a class=heading-link href=#setup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>To set up emacs-slack, just follow the helpful steps found on the <a href=https://github.com/yuya373/emacs-slack#how-to-get-token-the-harder-yet-officially-sanctioned-way>GitHub</a> page.</p><p>If you&rsquo;ve never heard of emacs-slack before, this will probably be enough for you. You have emacs-slack setup and running. Play with it. Live it. Love it. Forget about this post.</p><h2 id=still-here-let-s-dive-in>Still Here? Let&rsquo;s Dive In
<a class=heading-link href=#still-here-let-s-dive-in><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>All I need to do is figure out which functions in emacs-slack are responsible for sending messages, how to hook into those functions, and how I can programmatically access text in Emacs. Simple? Simple.</p><h3 id=slack-dot-el>slack.el
<a class=heading-link href=#slack-dot-el><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>My first steps will be to open up some of emacs-slack&rsquo;s files and see what I can divine. <a href=https://github.com/yuya373/emacs-slack/blob/master/slack.el>slack.el</a> seems like a good place to start. Let&rsquo;s see, there are a couple of <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/eintr/defcustom.html>defcustoms</a>, some defuns, and cl-defuns<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>&mldr; but nothing that looks like it has to do with sending messages, which is ultimately what I want to do.</p><p>Time to move on&mldr;</p><h3 id=slack-message-dot-el>slack-message.el
<a class=heading-link href=#slack-message-dot-el><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>I want to send a message, maybe <a href=https://github.com/yuya373/emacs-slack/blob/master/slack-message.el>slack-message.el</a> is a better place to start.</p><p>Ok&mldr; wait, what? defclass? defmethod? Since when was Emacs Lisp object oriented<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>?</p><p>So, it looks like Message is an object with a lot of methods. Helpful, but doesn&rsquo;t get me anything yet.</p><p>I&rsquo;ve read through two files, I&rsquo;ve learned some things about the structure of this package, but there are 50 .el files. If I keep looking through all of these files, it&rsquo;s going to be a lot of work! Maybe I can take a different approach.</p><h3 id=through-the-power-of-the-profiler-i-shall-not-be-defeated>Through the power of the profiler, I shall not be defeated!
<a class=heading-link href=#through-the-power-of-the-profiler-i-shall-not-be-defeated><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>I know of two ways to learn how code works in Emacs, besides just reading the source code. The first is the profiler built right into <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Profiling.html>Emacs</a>, and the other is the Elisp debugger, <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Edebug.html#Edebug>Edebug</a>. For now, I&rsquo;m going to start with the profiler &mdash; the easier approach.</p><p><em>M-x profiler-start</em> will track CPU, memory, or a combination of the two. My first thought is to send a few messages in Slack and see what pops up in the profiler. Hopefully, that will point me in the right direction and I&rsquo;ll find the magical invocations I need to recite to get my idea to work.</p><h3 id=a-peek-behind-the-veil>A Peek Behind The Veil
<a class=heading-link href=#a-peek-behind-the-veil><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Let&rsquo;s look at the top level of the profile trace found in the CPU buffer. Only two calls look like they are worth investigating: <code>command-execute</code> and <code>â¦</code>.</p><h4 id=cpu>CPU
<a class=heading-link href=#cpu><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>+ command-execute                                             67%
</span></span><span style=display:flex><span>+ redisplay_internal (C function)                             21%
</span></span><span style=display:flex><span>+ lui-scroll-post-command                                      9%
</span></span><span style=display:flex><span>+ #&lt;compiled 0x4da9630d&gt;                                       0%
</span></span><span style=display:flex><span>+ emojify-update-visible-emojis-background-after-command       0%
</span></span><span style=display:flex><span>+ company-post-command                                         0%
</span></span><span style=display:flex><span>+ request--curl-callback                                       0%
</span></span><span style=display:flex><span>+ ...                                                          0%
</span></span><span style=display:flex><span>+ timer-event-handler                                          0%
</span></span><span style=display:flex><span>+ undo-auto--add-boundary                                      0%
</span></span><span style=display:flex><span>+ sp--save-pre-command-state                                   0%
</span></span><span style=display:flex><span>+ global-hl-line-highlight                                     0%
</span></span></code></pre></div><h3 id=command-execute>Command-execute
<a class=heading-link href=#command-execute><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Expanding command-execute, we start to see some interesting calls&mldr;</p><h4 id=enhance>Enhance
<a class=heading-link href=#enhance><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>- command-execute                                         67%
</span></span><span style=display:flex><span> - call-interactively                                     67%
</span></span><span style=display:flex><span>  - apply                                                 67%
</span></span><span style=display:flex><span>   - call-interactively@ido-cr+-record-current-command    63%
</span></span><span style=display:flex><span>    - apply                                               63%
</span></span><span style=display:flex><span>     - #&lt;subr call-interactively&gt;                         63%
</span></span><span style=display:flex><span>      - funcall-interactively                             63%
</span></span><span style=display:flex><span>       + profiler-report                                  63%
</span></span><span style=display:flex><span>       - lui-send-input                                    0%
</span></span><span style=display:flex><span>        - slack-message--send                              0%
</span></span><span style=display:flex><span>         - let*                                            0%
</span></span><span style=display:flex><span>          - if                                             0%
</span></span><span style=display:flex><span>           - let*                                          0%
</span></span><span style=display:flex><span>            - if                                           0%
</span></span><span style=display:flex><span>             - slack-buffer-send-message                   0%
</span></span><span style=display:flex><span>              - apply                                      0%
</span></span><span style=display:flex><span>               - #&lt;compiled 0x4f23dd71&gt;                    0%
</span></span><span style=display:flex><span>                - apply                                    0%
</span></span><span style=display:flex><span>                 - #&lt;compiled 0x4db1669d&gt;                  0%
</span></span><span style=display:flex><span>                  - apply                                  0%
</span></span><span style=display:flex><span>                   - #&lt;lambda 0xdafed4764d8&gt;               0%
</span></span><span style=display:flex><span>                    - let*                                 0%
</span></span><span style=display:flex><span>                     - slack-message-send-internal         0%
</span></span><span style=display:flex><span>                      - let*                               0%
</span></span><span style=display:flex><span>                       - let*                              0%
</span></span><span style=display:flex><span>                        + slack-ws-send                    0%
</span></span><span style=display:flex><span>                        + json-encode                      0%
</span></span><span style=display:flex><span>                        + list                             0%
</span></span><span style=display:flex><span>                        + slack-message-create             0%
</span></span></code></pre></div><p><em>slack-message &mdash; send</em> and <em>slack-message-send-internal</em> seem to be the most promising, so let&rsquo;s look at these.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>slack-message--send</span> (<span style=color:#50fa7b>message</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>slack-if-let*</span> ((<span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#8be9fd;font-style:italic>slack-current-buffer</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>slack-if-let*</span> ((<span style=color:#8be9fd;font-style:italic>command</span> (<span style=color:#8be9fd;font-style:italic>slack-slash-commands-parse</span> <span style=color:#50fa7b>message</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#8be9fd;font-style:italic>slack-buffer-execute-slash-command</span> <span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#8be9fd;font-style:italic>command</span>)
</span></span><span style=display:flex><span>        (<span style=color:#8be9fd;font-style:italic>slack-buffer-send-message</span> <span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#50fa7b>message</span>))))
</span></span></code></pre></div><p>It looks like <em>slack-message &mdash; send</em> checks to see if the current buffer is a &ldquo;Slack Buffer&rdquo;, looks for &ldquo;Slack Commands&rdquo; to execute in the buffer, then passes the message onto another function <em>slack-buffer-send-message</em>. Unfortunately, this seems to rely too much on the internal state of the package, so let&rsquo;s move on to the next function and hope it&rsquo;s simpler.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>slack-message-send-internal</span> (<span style=color:#50fa7b>message</span> <span style=color:#8be9fd;font-style:italic>channel-id</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>slack-message-inc-id</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>with-slots</span> (<span style=color:#8be9fd;font-style:italic>message-id</span> <span style=color:#8be9fd;font-style:italic>sent-message</span> <span style=color:#8be9fd;font-style:italic>self-id</span>) <span style=color:#8be9fd;font-style:italic>team</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>let*</span> ((<span style=color:#8be9fd;font-style:italic>m</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>:id</span> <span style=color:#8be9fd;font-style:italic>message-id</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:channel</span> <span style=color:#8be9fd;font-style:italic>channel-id</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#f1fa8c>&#34;message&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:user</span> <span style=color:#8be9fd;font-style:italic>self-id</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:text</span> (<span style=color:#8be9fd;font-style:italic>slack-message-prepare-links</span>
</span></span><span style=display:flex><span>                           (<span style=color:#8be9fd;font-style:italic>slack-escape-message</span> <span style=color:#50fa7b>message</span>)
</span></span><span style=display:flex><span>                           <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span><span style=display:flex><span>           (<span style=color:#8be9fd;font-style:italic>json</span> (<span style=color:#8be9fd;font-style:italic>json-encode</span> <span style=color:#8be9fd;font-style:italic>m</span>))
</span></span><span style=display:flex><span>           (<span style=color:#8be9fd;font-style:italic>obj</span> (<span style=color:#8be9fd;font-style:italic>slack-message-create</span> <span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>slack-ws-send</span> <span style=color:#8be9fd;font-style:italic>json</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>      (<span style=color:#50fa7b>puthash</span> <span style=color:#8be9fd;font-style:italic>message-id</span> <span style=color:#8be9fd;font-style:italic>obj</span> <span style=color:#8be9fd;font-style:italic>sent-message</span>))))
</span></span></code></pre></div><p>Next up on my list is <em>slack-message-send-internal</em>. This immediately looks a lot more promising. It takes exactly the data I would expect: a message, a room id, and a team. Then, it composes the data into a keyed list and sends a JSON encoded object through a WebSocket. Jackpot!</p><p>Now onto my next problem&mldr;</p><h3 id=bugging-out>Bugging Out
<a class=heading-link href=#bugging-out><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>The Emacs profiler is nice to see what is being called, but how do I see what the data structures look like? I mean I need to know what they look like to insert them in the send-message-send-internal, right? <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Edebug.html#Edebug>Edebug</a> to the rescue! If you have any intention of writing elisp, I recommend you read this section of the Emacs Manual. I&rsquo;ve only recently discovered Edebug, but it has quickly become an invaluable tool when I explore code.</p><h4 id=tracing-through-slack-message-send>Tracing Through slack-message&ndash;send
<a class=heading-link href=#tracing-through-slack-message-send><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>I know what function I want to inspect, <em>slack-message-send-internal</em>, but I&rsquo;m also curious: how is data transformed and built-up as it&rsquo;s moving through this system? To answer that question we need to start inspecting earlier in the call chain. We&rsquo;ve already taken a quick look at slack-send&ndash;message, so let&rsquo;s add a <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Source-Breakpoints.html#Source-Breakpoints>source breakpoint</a>, and <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Instrumenting.html#Instrumenting>instrument</a> the function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>slack-message--send</span> (<span style=color:#50fa7b>message</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>edebug</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>slack-if-let*</span> ((<span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#8be9fd;font-style:italic>slack-current-buffer</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>slack-if-let*</span> ((<span style=color:#8be9fd;font-style:italic>command</span> (<span style=color:#8be9fd;font-style:italic>slack-slash-commands-parse</span> <span style=color:#50fa7b>message</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#8be9fd;font-style:italic>slack-buffer-execute-slash-command</span> <span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#8be9fd;font-style:italic>command</span>)
</span></span><span style=display:flex><span>        (<span style=color:#8be9fd;font-style:italic>slack-buffer-send-message</span> <span style=color:#8be9fd;font-style:italic>buf</span> <span style=color:#50fa7b>message</span>))))
</span></span></code></pre></div><p>I&rsquo;ve added a breakpoint to the function, <em>edebug</em>. Now we just need to instrument the function. An easy way to instrument functions is to move my cursor to the beginning of the function definition and call <em>M-x edebug-eval-top-level-form</em>. This evaluates the current function and instruments it so Edebug can perform its magic.</p><p>After tracing through the functions I see that message, channel-id, and team have the following structure:</p><table><thead><tr><th>message</th><th>#(&ldquo;Hello World&rdquo; 0 4 (fontified t ws-butler-chg chg))</th></tr></thead><tbody><tr><td>channel-id</td><td>&ldquo;D884GPDM0&rdquo;</td></tr><tr><td>team</td><td>#23=#</td></tr></tbody></table><p>It looks like message can be any string. I still need to find out how to select the team and channel I want to post to.</p><h3 id=slack-channel-select>slack-channel-select
<a class=heading-link href=#slack-channel-select><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Luckily, I have a good idea of where to look. Every time I want to enter a Slack channel I run the command <em>M-x slack-channel-select</em>, so let&rsquo;s take a look at that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>slack-channel-select</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let*</span> ((<span style=color:#8be9fd;font-style:italic>team</span> (<span style=color:#8be9fd;font-style:italic>slack-team-select</span>))
</span></span><span style=display:flex><span>         (<span style=color:#8be9fd;font-style:italic>room</span> (<span style=color:#8be9fd;font-style:italic>slack-room-select</span>
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>cl-loop</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>in</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>                         <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>channels</span> <span style=color:#50fa7b>=</span> (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>channels</span>)
</span></span><span style=display:flex><span>                         <span style=color:#50fa7b>nconc</span> <span style=color:#8be9fd;font-style:italic>channels</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>slack-room-display</span> <span style=color:#8be9fd;font-style:italic>room</span> <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span></code></pre></div><p>That looks perfect. I can copy-paste 90% of this code into my own function and we&rsquo;ll have something close to working.</p><h3 id=so-a-foo-walks-into-a-bar>So A Foo Walks Into A Bar
<a class=heading-link href=#so-a-foo-walks-into-a-bar><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>My first test was to see if I could quickly modify this function to get a prototype working.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>jb/say-hello-to-slack</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let*</span> ((<span style=color:#8be9fd;font-style:italic>team</span> (<span style=color:#8be9fd;font-style:italic>slack-team-select</span>))
</span></span><span style=display:flex><span>         (<span style=color:#8be9fd;font-style:italic>room</span> (<span style=color:#8be9fd;font-style:italic>slack-room-select</span>
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>cl-loop</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>in</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>                         <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>channels</span> <span style=color:#50fa7b>=</span> (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>channels</span>)
</span></span><span style=display:flex><span>                         <span style=color:#50fa7b>nconc</span> <span style=color:#8be9fd;font-style:italic>channels</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>slack-message-send-internal</span> <span style=color:#f1fa8c>&#34;Hello World&#34;</span>
</span></span><span style=display:flex><span>                                 (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>room</span> <span style=color:#8be9fd;font-style:italic>id</span>)
</span></span><span style=display:flex><span>                                 <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span></code></pre></div><p>Now to test it!</p><figure><img src=/images/hello-world.gif alt="Figure 1: Example of the above function jb/say-hello-to-slack"><figcaption><p>Figure 1: Example of the above function jb/say-hello-to-slack</p></figcaption></figure><h3 id=buffers-regions-and-everything-between>Buffers, Regions, And Everything Between
<a class=heading-link href=#buffers-regions-and-everything-between><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Now the last problem I need to solve: I need to figure out how to copy a region of text. I&rsquo;m not sure how to do that, but I do know of a great resource for learning elisp, Emacs&rsquo; own <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/>Elisp Manual</a><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. The key parts that we need to be aware of from this manual are <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/The-Region.html#The-Region>Regions</a> and <a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Buffer-Contents.html#Buffer-Contents>Buffer Contents.</a></p><p>As an example of how I learned to programmatically access text in a region, I&rsquo;ve outlined a simple function below that prints out the content of a selected region to the minibuffer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>jb/echo-region</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#50fa7b>message</span> (<span style=color:#8be9fd;font-style:italic>filter-buffer-substring</span> (<span style=color:#50fa7b>region-beginning</span>) (<span style=color:#50fa7b>region-end</span>))))
</span></span></code></pre></div><p>This finally leads me to have all the tools to create a function where I can post from any buffer into slack</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>jb/send-region-to-slack</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>team</span> (<span style=color:#8be9fd;font-style:italic>slack-team-select</span>)) <span style=color:#6272a4>;; Select team</span>
</span></span><span style=display:flex><span>        (<span style=color:#8be9fd;font-style:italic>room</span> (<span style=color:#8be9fd;font-style:italic>slack-room-select</span>
</span></span><span style=display:flex><span>               (<span style=color:#8be9fd;font-style:italic>cl-loop</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>in</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>                        <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>channels</span> <span style=color:#50fa7b>=</span> (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>channels</span>)
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>nconc</span> <span style=color:#8be9fd;font-style:italic>channels</span>)))) <span style=color:#6272a4>;; Get all rooms from selected team</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>slack-message-send-internal</span> (<span style=color:#8be9fd;font-style:italic>filter-buffer-substring</span> (<span style=color:#50fa7b>region-beginning</span>) (<span style=color:#50fa7b>region-end</span>))
</span></span><span style=display:flex><span>                                 (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>room</span> <span style=color:#8be9fd;font-style:italic>id</span>)
</span></span><span style=display:flex><span>                                 <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span></code></pre></div><h4 id=codifying-my-message>Codifying My Message
<a class=heading-link href=#codifying-my-message><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>One last enhancement to my function that I want to make: I am almost always going to be sending some chunk of code to Slack, so I want to wrap it in three backticks so Slack will apply the proper markup to it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>jb/send-region-to-slack-code</span> ()
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>team</span> (<span style=color:#8be9fd;font-style:italic>slack-team-select</span>)) <span style=color:#6272a4>;; Select team</span>
</span></span><span style=display:flex><span>        (<span style=color:#8be9fd;font-style:italic>room</span> (<span style=color:#8be9fd;font-style:italic>slack-room-select</span>
</span></span><span style=display:flex><span>               (<span style=color:#8be9fd;font-style:italic>cl-loop</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>in</span> (<span style=color:#50fa7b>list</span> <span style=color:#8be9fd;font-style:italic>team</span>)
</span></span><span style=display:flex><span>                        <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#8be9fd;font-style:italic>channels</span> <span style=color:#50fa7b>=</span> (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>team</span> <span style=color:#8be9fd;font-style:italic>channels</span>)
</span></span><span style=display:flex><span>                        <span style=color:#50fa7b>nconc</span> <span style=color:#8be9fd;font-style:italic>channels</span>)))) <span style=color:#6272a4>;; Get all rooms from selected team</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>slack-message-send-internal</span> (<span style=color:#50fa7b>concat</span> <span style=color:#f1fa8c>&#34;```&#34;</span>(<span style=color:#8be9fd;font-style:italic>filter-buffer-substring</span> (<span style=color:#50fa7b>region-beginning</span>) (<span style=color:#50fa7b>region-end</span>)) <span style=color:#f1fa8c>&#34;```&#34;</span>)
</span></span><span style=display:flex><span>                                 (<span style=color:#8be9fd;font-style:italic>oref</span> <span style=color:#8be9fd;font-style:italic>room</span> <span style=color:#8be9fd;font-style:italic>id</span>)
</span></span><span style=display:flex><span>                                 <span style=color:#8be9fd;font-style:italic>team</span>)))
</span></span></code></pre></div><p>1700 words to describe a 10 line function, I don&rsquo;t understand all the hate that Emacs gets.</p><ul><li>Editor&rsquo;s note:</li></ul><pre><code>These are transferred over from my medium blog, if you found any errors caused during the transition please let me know on twitter
</code></pre><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>As I was reading through the slack code I found it interesting that Emacs&rsquo; defun was different from a CL implementation of defun. Richard Stallman hated how you could use keys to destructure arguments in Common Lisp and chose to omit that feature in elisp. <a href=https://www.emacswiki.org/emacs/KeywordArguments>https://www.emacswiki.org/emacs/KeywordArguments</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Fun note, Emacs Lisp has had an object system, â<a href=https://www.gnu.org/software/emacs/manual/html%5Fnode/eieio/>Enhanced Implementation of Emacs Interpreted Objects</a>â, since at least 2007 and maybe earlier<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>This is a lie, I didn&rsquo;t know about this manual until I started writing this post. This would have saved me hours of very poor google-fu.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>EIEIO is actually inspired by <a href=https://en.wikipedia.org/wiki/Common%5FLisp%5FObject%5FSystem>Common Lisp Object System</a>, doing this dive into Emacs-Slack is teaching me so much about Emacs and Common Lisp!&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer></footer></article></section></div><footer class=footer><section class=container>Â©
2017 -
2024
Justin Barclay
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>