<!doctype html><html lang=en><head><title>1Password Across The Void · Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="1Password, one set of ssh keys, across many environments"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="1Password Across The Void"><meta name=twitter:description content="1Password, one set of ssh keys, across many environments"><meta property="og:title" content="1Password Across The Void"><meta property="og:description" content="1Password, one set of ssh keys, across many environments"><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/1password-across-the-void/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-27T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-27T00:00:00+00:00"><link rel=canonical href=https://justinbarclay.ca/posts/1password-across-the-void/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/1password-across-the-void/>1Password Across The Void</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-04-27T00:00:00Z>April 27, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
5-minute read</span></div></div></header><div class=post-content><p><div class=banner-image></p><img src=/images/an-oil-painting-of-the-moon.png alt='"An astronaut crossing the void"' title=/images/an-oil-painting-of-the-moon.png><p></div></p><p><h2>Using 1Password on Windows from WSL2</h2></p><p>Recently, I've grown attached to the philosophy of <a href=https://nixos.org/>Nix</a> and <a href=https://guix.gnu.org/>Guix</a>. I've become so enamoured with declarative system configuration that I've converted my dev environment with Nix and NixOS. This is great because I can easily sync my dev environment setup from my laptop to my desktop or even to a new machine. This process works great except in one spot, signing commits with <a href=https://gnupg.org/>GPG</a>.</p><p>I define my <a href=https://git-scm.com/docs/git-config><code>.gitconfig</code></a> file within a Nix Flake, which means that the signing key I use for <code>git commit</code> is defined in Nix. So I have two machines trying to reference the same GPG key, which I could copy from one machine to the next and manually keep in sync, but that seems like bad form.</p><p>I've been using <a href=https://1password.com/>1Password</a> for years, and I have been a mostly<sup class=footnote-reference><a id=footnote-reference-1 href=#footnote-1>1</a></sup> happy customer. Recently<sup class=footnote-reference><a id=footnote-reference-2 href=#footnote-2>2</a></sup>, 1Password released an <a href=https://blog.1password.com/1password-ssh-agent/>SSH key management system</a> where they will generate or import your SSH keys and serve them through a custom SSH Agent. In another blog post, they outlined how this system can be used to <a href=https://blog.1password.com/git-commit-signing/>sign commits</a> with SSH keys.</p><p>I love this idea. I get syncable SSH Keys that are protected behind the Biometrics of <a href=https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/windows-hello>Windows Hello</a>.</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>Windows 11</h2><div id=outline-text-headline-1 class=outline-text-2><p>Setting up Git to use 1Password for authentication and verification on Windows 11 is simple. You need to:</p><ol><li>Add your SSH keys to 1Password</li><li>turn on the <a href=https://developer.1password.com/docs/ssh/get-started/#step-3-turn-on-the-1password-ssh-agent>1Password SSH Agent</a></li><li>Tell your Git config about your new signing key and that you're using SSH to sign commits.</li></ol><p>Your <code>.gitconfig</code> should look something like this:</p><div class="src src-toml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[user]
</span></span><span style=display:flex><span>  signingkey = ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIN1pYfD9AiFZUIKILYVimUjXqEAH7nphmnoeZO3+kd44cC
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[gpg]
</span></span><span style=display:flex><span>  format = ssh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[gpg <span style=color:#f1fa8c>&#34;ssh&#34;</span>]
</span></span><span style=display:flex><span>  program = <span style=color:#f1fa8c>&#34;C:/Users/justin/AppData/Local/1Password/app/8/op-ssh-sign.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[commit]
</span></span><span style=display:flex><span>  gpgsign = <span style=color:#ff79c6>true</span></span></span></code></pre></div></div><p>Now you can <code>git commit</code>, <code>git push</code>, and <code>rm -rf /</code> to your heart's content. Well, maybe not that last one.</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>WSL2</h2><div id=outline-text-headline-2 class=outline-text-2><p>However, this setup no longer works once you cross the void and move into WSL2. You have to remember that this WSL2 is a virtual machine, and it has its own copy of SSH.</p><p>At the time of this writing, if you scour the web for how to hook up SSH on WSL2 with the 1Password running on Windows, you will find 1 solution. You could set up a <a href=https://learn.microsoft.com/en-us/windows/win32/ipc/named-pipes>named pipe</a> on the Windows side to talk to 1Password's SSH Agent and use <a href=https://learn.microsoft.com/en-us/windows/win32/ipc/named-pipes>npiperelay</a> on WSL to communicate to that named pipe. You can read more about that <a href=https://learn.microsoft.com/en-us/windows/win32/ipc/named-pipes>here</a>.</p><p>But there is a simpler way. If you've used WSL2 before, then you know that you can <a href=https://learn.microsoft.com/en-us/windows/wsl/filesystems#run-windows-tools-from-linux>call Windows applications</a> from WSL2, so why not use the Windows version of SSH too?</p><p>We can validate that we can call the Windows variant of SSH from a WSL2 shell:</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh.exe -V</span></span></code></pre></div></div><p>It should output something like this:</p><blockquote class=not-prose><p>OpenSSH_for_Windows_8.6p1, LibreSSL 3.4.3</p></blockquote><p>If you don't get a result, that might be because <code>ssh.exe</code> isn't on your path. Instead, you might need to call it directly. On Windows 11, SSH can be found in System32:</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/mnt/c/WINDOWS/System32/OpenSSH//ssh.exe -V</span></span></code></pre></div></div><p>Again we get the same result:</p><blockquote class=not-prose><p>OpenSSH_for_Windows_8.6p1, LibreSSL 3.4.3</p></blockquote><p>If that <span style=text-decoration:underline>still</span> doesn't work, you might have turned off <a href=https://learn.microsoft.com/en-us/windows/wsl/wsl-config#interop-settings>interop</a> and you're in gods hands now.</p><p>We know we can talk to SSH on Windows, but can we still gain access to 1Password? Well, we can verify that by calling <code>ssh-add.exe</code>:</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-add.exe -L
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># or /mnt/c/WINDOWS/System32/OpenSSH//ssh-add.exe -L</span></span></span></code></pre></div></div><p>And it should show you the SSH keys you have stored in 1Password:<div class=table-scroll></p><table><tbody><tr><td>ssh-ed25519</td><td>AAAAC3NzaC1lZDI1NTE5AAAAIGFbygxEvFlS66vaugGRlbXR12yjozS8G+yYrK23lmZo</td><td>SSH</td><td>Signing</td><td>Key</td></tr><tr><td>ssh-ed25519</td><td>AAAAC3NzaC1lZDI1NTE5AAAAIHyfKl/29RIys3r+UsyM6ODnh04tI01iUBeBjornOrnl</td><td>SSH</td><td>Auth</td><td>Key</td></tr></tbody></table><p></div></p><p>Now that we have verified that we have access to SSH and 1Password's SSH agent, we have to tell Git about it:</p><div class="src src-toml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[core]
</span></span><span style=display:flex><span>  sshProgram = <span style=color:#f1fa8c>&#34;ssh.exe&#34;</span></span></span></code></pre></div></div><p>Or, if you prefer not to have Windows applications on your path:</p><div class="src src-toml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[core]
</span></span><span style=display:flex><span>  sshProgram = <span style=color:#f1fa8c>&#34;/mnt/c/WINDOWS/System32/OpenSSH//ssh.exe&#34;</span></span></span></code></pre></div></div><p>Enjoy your biometrically protected SSH keys :)</p><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>Bonus: Sign commits with SSH</h3><div id=outline-text-headline-3 class=outline-text-3><p>Getting SSH authentication was only the start for me. What I was really interested in was having SSH keys that can sign my commits. And if you remember from the Windows config, 1Password had its own SSH signing program.</p><div class="src src-toml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[gpg <span style=color:#f1fa8c>&#34;ssh&#34;</span>]
</span></span><span style=display:flex><span>  program = <span style=color:#f1fa8c>&#34;C:/Users/justin/AppData/Local/1Password/app/8/op-ssh-sign.exe&#34;</span></span></span></code></pre></div></div><p>Unfortunately, we can't just copy this config as is. Instead, we must translate this from a Windows path to a Unix path. That just requires changing any <code>\</code> path separators to <code>/</code> and replace <code>C:/</code> with <code>/mnt/c/</code></p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f1fa8c>&#34;/mnt/c/Users/justin/AppData/Local/1Password/app/8/op-ssh-sign.exe&#34;</span></span></span></code></pre></div></div><p>Alternatively, you can add the 1Password directory to your Windows environment variables. Using Powershell, that would look something like this:</p><div class="src src-powershell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>  [Environment]::SetEnvironmentVariable(
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>&#34;Path&#34;</span>,
</span></span><span style=display:flex><span>      [Environment]::GetEnvironmentVariable(<span style=color:#f1fa8c>&#34;Path&#34;</span>, [EnvironmentVariableTarget]::User) + <span style=color:#f1fa8c>&#34;;C:\Users\justin\AppData\Local\1Password\app\8&#34;</span>,
</span></span><span style=display:flex><span>      [EnvironmentVariableTarget]::User)</span></span></code></pre></div></div><p>Now we put everything together and the final product should look very similar to this:</p><div class="src src-toml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[core]
</span></span><span style=display:flex><span>  sshProgram = <span style=color:#f1fa8c>&#34;ssh.exe&#34;</span>
</span></span><span style=display:flex><span>[user]
</span></span><span style=display:flex><span>  signingkey = ssh-ed25519 &lt;your signing key&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[gpg]
</span></span><span style=display:flex><span>  format = ssh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[gpg <span style=color:#f1fa8c>&#34;ssh&#34;</span>]
</span></span><span style=display:flex><span>  program = <span style=color:#f1fa8c>&#34;op-ssh-sign.exe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[commit]
</span></span><span style=display:flex><span>  gpgsign = <span style=color:#ff79c6>true</span></span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>Warning</h2><div id=outline-text-headline-4 class=outline-text-2><p><del>1Password's SSH integration works best for WSL2 using <em>1Password 8.10.3</em>. If you go to newer versions, it ends up hiding some authentication prompts from you. If you use Git directly in the terminal, you might be fine, but I use <a href=https://magit.vc/>Magit</a>, and the newer versions totally break my process.</del></p><p>AgileBits has fixed this issue as of <a href=https://releases.1password.com/windows/beta/#1password-for-windows-8.10.6-20><em>1Password for Windows 8.10.6 (81006026)</em></a>.</p></div></div><div id=outline-container-headline-5 class=outline-2><h2 id=headline-5>Footnotes</h2></div><div class=footnotes><hr class=footnotes-separatator><div class=footnote-definitions><div class=footnote-definition><sup id=footnote-1><a href=#footnote-reference-1>1</a></sup><div class=footnote-body><p>1Password's Android/Firefox support needs to be improved. It doesn't detect enough website forms as login forms, so I have to log into the 1Password app and copy+paste too many times.</p></div></div><div class=footnote-definition><sup id=footnote-2><a href=#footnote-reference-2>2</a></sup><div class=footnote-body><p>For specific definitions of recent, March 2022 is recent for me.</p></div></div></div></div></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2024
Justin Barclay
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>