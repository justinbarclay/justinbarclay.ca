<!doctype html><html lang=en><head><title>Sharpening Your Toolshed: Sanding down the rough edges of git-sync Â· Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="Improving the user experience of git-sync-mode"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sharpening Your Toolshed: Sanding down the rough edges of git-sync"><meta name=twitter:description content="Improving the user experience of git-sync-mode"><meta property="og:title" content="Sharpening Your Toolshed: Sanding down the rough edges of git-sync"><meta property="og:description" content="Improving the user experience of git-sync-mode"><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/sanding-down-git-sync/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-04T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-04T00:00:00+00:00"><meta property="og:see_also" content="https://justinbarclay.ca/posts/automating-git-sync-part-2/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/automating-git-sync/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/sharpening-your-toolshed/"><link rel=canonical href=https://justinbarclay.ca/posts/sanding-down-git-sync/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/sanding-down-git-sync/>Sharpening Your Toolshed: Sanding down the rough edges of git-sync</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-02-04T00:00:00Z>February 4, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
9-minute read</span></div></div></header><div class=post-content><p><div class=banner-image><img style=max-height:700px alt="A dark, surreal scene inspired by H.R. Giger, depicting two humanoid figures in a biomechanical environment, using Emacs and Git to automatically sync their work. The figures are connected to a network of organic-looking cables and machinery, with their fingers fused into the keyboard, seamlessly blending technology and biology. The screens in front of them display code and Git commands, surrounded by an eerie glow. The atmosphere is filled with a sense of advanced, alien technology, as the figures work in harmony, their actions synchronized through the Git repository." src=/images/geigeresque-depiction-of-git-sync-mode.webp></div></p><p>There are three things that still annoy me with my git-sync mode:</p><ol><li>The <code>git-sync</code> process buffer shows <code>^M</code> rather than a new line</li><li>There is no way to ignore files in a directory or project</li><li><code>git-sync</code> requires a bash shell script to run.</li></ol><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Processing the process output</h3><div id=outline-text-headline-1 class=outline-text-3><p>When I run git-sync in a buffer, sometimes I get lines that sprinkle <code>^M</code> everywhere:</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>  <span style=color:#6272a4>#...</span>
</span></span><span style=display:flex><span>  Counting objects:  20% <span style=color:#ff79c6>(</span>1/5<span style=color:#ff79c6>)</span>^MCounting objects:  40% <span style=color:#ff79c6>(</span>2/5<span style=color:#ff79c6>)</span>^MCounting objects:  60% <span style=color:#ff79c6>(</span>3/5<span style=color:#ff79c6>)</span>^MCounting objects:  80% <span style=color:#ff79c6>(</span>4/5<span style=color:#ff79c6>)</span>^MCounting objects: 100% <span style=color:#ff79c6>(</span>5/5<span style=color:#ff79c6>)</span>^MCounting objects: 100% <span style=color:#ff79c6>(</span>5/5<span style=color:#ff79c6>)</span>, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>  Delta compression using up to <span style=color:#bd93f9>8</span> threads
</span></span><span style=display:flex><span>  Compressing objects:  33% <span style=color:#ff79c6>(</span>1/3<span style=color:#ff79c6>)</span>^MCompressing objects:  66% <span style=color:#ff79c6>(</span>2/3<span style=color:#ff79c6>)</span>^MCompressing objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>^MCompressing objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>  Writing objects:  33% <span style=color:#ff79c6>(</span>1/3<span style=color:#ff79c6>)</span>^MWriting objects:  66% <span style=color:#ff79c6>(</span>2/3<span style=color:#ff79c6>)</span>^MWriting objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>^MWriting objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>, <span style=color:#bd93f9>555</span> bytes | 555.00 KiB/s, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>  Total <span style=color:#bd93f9>3</span> <span style=color:#ff79c6>(</span>delta 2<span style=color:#ff79c6>)</span>, reused <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>(</span>delta 0<span style=color:#ff79c6>)</span>, pack-reused <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>  remote: Resolving deltas:   0% <span style=color:#ff79c6>(</span>0/2<span style=color:#ff79c6>)</span>        ^Mremote: Resolving deltas:  50% <span style=color:#ff79c6>(</span>1/2<span style=color:#ff79c6>)</span>        ^Mremote: Resolving deltas: 100% <span style=color:#ff79c6>(</span>2/2<span style=color:#ff79c6>)</span>        ^Mremote: Resolving deltas: 100% <span style=color:#ff79c6>(</span>2/2<span style=color:#ff79c6>)</span>, completed with <span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>local</span> objects.
</span></span><span style=display:flex><span>  <span style=color:#6272a4>#...</span></span></span></code></pre></div></div><p>I know Emacs has the <a href=https://git.savannah.gnu.org/cgit/emacs.git/tree/lisp/ansi-color.el>ansi-color</a> library to handle adding <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Faces.html>faces</a> to terminal output and Emacs does some <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Default-Coding-Systems.html>default handling</a> of ANSI escape characters. However, I haven't found one that handles hiding things like <code>^M</code> when they show up.</p><p>I'm too lazy to emulate the <code>^M</code>, <a href=https://en.wikipedia.org/wiki/Carriage_return>carriage return</a>, properly. Instead, I'll try to emulate a dumb terminal and treat <code>^M</code> as a newline.</p><p>First, I need to move the cursor to the beginning of the buffer</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#50fa7b>goto-char</span> (<span style=color:#50fa7b>point-min</span>))</span></span></code></pre></div></div><p>and then run a <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Regexp-Replace.html>regex replace</a></p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>replace-regexp</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &#34;</span> (<span style=color:#50fa7b>point-min</span>) (<span style=color:#50fa7b>point-max</span>))</span></span></code></pre></div></div><p>If you remember from my previous post on <a href=/posts/automating-git-sync-part-2>git-sync</a>, there is a <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Sentinels.html>sentinel function</a> that is called whenever new input is received from the process.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>special-mode</span>)))</span></span></code></pre></div></div><p>So, all I need to do is extend that function, and I'll have a prettier buffer.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Sentinel function for the git-sync process.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>read-only-mode</span> <span style=color:#bd93f9>-1</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>replace-regexp-in-region</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   &#34;</span> (<span style=color:#50fa7b>point-min</span>) (<span style=color:#50fa7b>point-max</span>))
</span></span><span style=display:flex><span>      (<span style=color:#50fa7b>goto-char</span> (<span style=color:#50fa7b>point-min</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>special-mode</span>)))</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Ignoring the ignoble</h3><div id=outline-text-headline-2 class=outline-text-3><p>My next line item is to create allow and deny lists that can be altered using <code>M-x</code> commands.</p><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>But make it customizable</h4><div id=outline-text-headline-3 class=outline-text-4><p>To store our lists, we could use <a href=https://www.gnu.org/software/emacs/manual/html_node/eintr/Using-setq.html><code>setq</code></a>.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> <span style=color:#ff79c6>&#39;</span>())</span></span></code></pre></div></div><p>But this is uncouth and would have you looked down upon in the more refined circles. So, I prefer to never define variables with <code>setq</code>; <code>setq</code> is for <span style=text-decoration:underline>modifying</span> variables only.</p><p>I could be a bit more civilized and use <a href=https://www.gnu.org/software/emacs/manual/html_node/eintr/defvar.html><code>defvar</code></a>. It allows me to add a comment to describe what the variable is for.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defvar</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> <span style=color:#ff79c6>&#39;</span>() <span style=color:#f1fa8c>&#34;A list of directories and files that git sync is allowed to run in&#34;</span>)</span></span></code></pre></div></div><p>That means users could use <code>M-x describe-variable</code> to see what the variable stores.</p><p>Or, I could be my best self and use <a href=https://www.gnu.org/software/emacs/manual/html_node/eintr/defcustom.html><code>defcustom</code></a>. This tells Emacs that the variable represents a user-configurable setting and that it should show up in Emacs' <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Easy-Customization.html>customization UI</a>. The example below allows users to find the setting using the <code>M-x customize-option thing</code>.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>thing</span> <span style=color:#ff79c6>&#39;</span>()
</span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;A thing&#34;</span>)</span></span></code></pre></div></div><p>Customization widgets can get pretty <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Customization.html#Customization>complex</a>, but I only care about the <code>:type</code> and <code>:group</code> configurations. <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Group-Definitions.html>:group</a> is a way to cluster similar options within Emacs' customize UI. For example, say a package maintainer wanted to make it so users could see all the possible customizations for their package on one page.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defgroup</span> <span style=color:#8be9fd;font-style:italic>git-sync</span>
</span></span><span style=display:flex><span>    nil
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Customizations for git-sync&#34;</span>)</span></span></code></pre></div></div><p>Meanwhile, <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Customization-Types.html>:type</a> specifies the type of widget that Emacs will present to the user. For example, you could specify the <code>'directory</code> type to say that you want Emacs to create a widget that helps users select a directory. Or I could say <code>'(repeat directory)</code> to say that it should allow the user to enter more than one directory in the UI.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> <span style=color:#ff79c6>&#39;</span>()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A list of files that git-sync is allowed to run in. In case of conflict with the deny-list, the deny-list wins out.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>)</span></span></code></pre></div></div><p>I also want to allow users to specify a deny list.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#39;</span>()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A list of files that git-sync is not allowed to run in. In case of conflict with the allow-list, the deny-list wins out.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>)</span></span></code></pre></div></div><p><img src=/images/git-sync-customize.png alt=/images/git-sync-customize.png title=/images/git-sync-customize.png></p></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>Through Interactivity</h4><div id=outline-text-headline-4 class=outline-text-4><p>Then I need to add some <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Using-Interactive.html>interactive commands</a> to add directories to the allow and deny lists</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-allow-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add the folder of the current buffer to </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-allow-list</span> (<span style=color:#50fa7b>file-name-directory</span> <span style=color:#50fa7b>buffer-file-name</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-deny-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add the folder of the current buffer to </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-deny-list</span> (<span style=color:#50fa7b>file-name-directory</span> <span style=color:#50fa7b>buffer-file-name</span>)))</span></span></code></pre></div></div><p>However, this isn't quite the right UX. Rather than assuming that the user means the current directory, I'd like the user to select the file or directory they want. For that, I'd use the <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Minibuffer-Completion.html>completing-read</a> function <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Reading-Directory-Names.html>read-directory-name</a>. I can feed it a prompt for the user and then have the user select the current directory, which is the default behaviour, or they can interactively select the directory.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>read-directory-name</span> <span style=color:#f1fa8c>&#34;This is the prompt&#34;</span>)</span></span></code></pre></div></div><p>Putting this together, we get</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-allow-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add directory to the </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>read-directory-name</span> <span style=color:#f1fa8c>&#34;Directory to add to git-sync-allow-list: &#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-deny-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add directory to the </span><span style=color:#f1fa8c>`git-sync-deny-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>read-directory-name</span> <span style=color:#f1fa8c>&#34;Directory to add to git-sync-deny-list: &#34;</span>)))</span></span></code></pre></div></div><p>I can also use a similar trick with <code>completing-read</code> to remove items from these lists. Completing read takes a <code>prompt</code> and a <code>collection</code> for the user to choose from and then returns the user's selection.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#50fa7b>completing-read</span> <span style=color:#8be9fd;font-style:italic>prompt</span> <span style=color:#8be9fd;font-style:italic>collection</span>)</span></span></code></pre></div></div><p>So, for my use case, I can use the user's choice alongside the <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Sets-And-Lists.html><code>remove</code></a> function to remove their choice from the allow or deny list.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-remove-from-allow-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Remove an item from the </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>remove</span> (<span style=color:#50fa7b>completing-read</span>
</span></span><span style=display:flex><span>                                       <span style=color:#f1fa8c>&#34;Select the item to remove: &#34;</span>
</span></span><span style=display:flex><span>                                       <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-remove-from-deny-list</span> ()
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>&#34;Remove an item from the </span><span style=color:#f1fa8c>`git-sync-deny-list&#39;</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span> (<span style=color:#8be9fd;font-style:italic>remove</span> (<span style=color:#50fa7b>completing-read</span>
</span></span><span style=display:flex><span>                                         <span style=color:#f1fa8c>&#34;Select the item to remove: &#34;</span>
</span></span><span style=display:flex><span>                                         <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span>))))</span></span></code></pre></div></div></div></div></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Unshelling git sync</h3><div id=outline-text-headline-5 class=outline-text-3><p>And now the piece de resistance. <code>git-sync-mode</code> relies on a shell script, which limits the portability of this mode. It will only work on *Nix systems. Meanwhile, in theory, Emacs <span style=text-decoration:underline>can</span> do the basics of what we want out of <code>git-sync</code>. It can tell git to stage files, commit them to the repo, and fetch or push the changes.</p><p>In short, the steps look something like this</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git add .
</span></span><span style=display:flex><span>git commit -m <span style=color:#f1fa8c>&#34;changes from Heimdall.localdomain on Wed Jan 24 09:29:28 PST 2024&#34;</span>
</span></span><span style=display:flex><span>git pull
</span></span><span style=display:flex><span>git push</span></span></code></pre></div></div><p>If you remember, earlier in the series, we can do the same with Elisp. First, we start by creating a shell process.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;status&#34;</span>)
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#f1fa8c>&#39;git-sync--sentinel-fn</span>)</span></span></code></pre></div></div><p>But we want to call several git commands in a row, not just once. Can we be lazy and concatenate the four lines into one list?</p><p>For readability, I'll use append</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#50fa7b>append</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;add&#34;</span> <span style=color:#f1fa8c>&#34;.&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;commit&#34;&#34; \&#34;-m&#34;</span> <span style=color:#f1fa8c>&#34;\&#34;Some message\&#34;&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;pull&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;push&#34;</span>))</span></span></code></pre></div></div><p>Which Emacs evaluates to</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;add&#34;</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#f1fa8c>&#34;;&#34;</span> <span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;commit&#34;</span> <span style=color:#f1fa8c>&#34; \&#34;-m&#34;</span> <span style=color:#f1fa8c>&#34;\&#34;Some message\&#34;&#34;</span> <span style=color:#f1fa8c>&#34;;&#34;</span> <span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;pull&#34;</span> <span style=color:#f1fa8c>&#34;;&#34;</span> <span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;push&#34;</span>)</span></span></code></pre></div></div><p>If I wrote this as a shell command, it would work, but does it work for Emacs when it tries to run it as a process?</p><p>In essence, will this work?</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>command</span> (<span style=color:#50fa7b>append</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;add&#34;</span> <span style=color:#f1fa8c>&#34;.&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;commit&#34;&#34; \&#34;-m&#34;</span> <span style=color:#f1fa8c>&#34;\&#34;changes from Heimdall.localdomain on Wed Jan 24 09:29:28 PST 2024\&#34;&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;pull&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;push&#34;</span>) <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;;&#34;</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#8be9fd;font-style:italic>command</span>
</span></span><span style=display:flex><span>                  <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#f1fa8c>&#39;git-sync--sentinel-fn</span>))</span></span></code></pre></div></div><p>Unfortunately, in the <code>*git-sync*</code> buffer, I get the following error</p><blockquote><p>fatal: pathspec ';' did not match any files</p></blockquote><p>I guess running commands in a process through Emacs differs from running commands through a shell.</p><p>Instead, I'll use an <a href=https://github.com/chuntaro/emacs-async-await>async</a> package called <code>emacs-async-await</code>. I'll forego an explanation on how to install <code>async-await</code>, but it is available on <a href=https://melpa.org/#/async-await>Melpa</a>.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;async-await</span>)
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>lexical-binding</span> <span style=color:#f1fa8c>&#39;t</span>)</span></span></code></pre></div></div><p>If you're familiar with <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise>Promises</a> in Javascript, then you should be able to understand the basics of how this works.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>promise-then</span>
</span></span><span style=display:flex><span>   (<span style=color:#8be9fd;font-style:italic>promise-new</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>reject</span>)
</span></span><span style=display:flex><span>                  (<span style=color:#50fa7b>funcall</span> <span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#f1fa8c>&#34;done&#34;</span>)))
</span></span><span style=display:flex><span>   (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>status</span>)
</span></span><span style=display:flex><span>     (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;%s&#34;</span> <span style=color:#8be9fd;font-style:italic>status</span>)))</span></span></code></pre></div></div><blockquote><p>Did you know that Emacs is a <a href=http://www.nhplace.com/kent/Papers/Technical-Issues.html>Lisp 2</a>? That's why we have to call <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Calling-Functions.html#index-funcall><code>funcall</code></a> on resolve.</p></blockquote><p>So we can promisify <code>git-sync--execute</code> function.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>promise-new</span> (<span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>reject</span>)
</span></span><span style=display:flex><span>       (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                     <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                     <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;status&#34;</span>)
</span></span><span style=display:flex><span>                     <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#f1fa8c>&#39;git-sync--sentinel-fn</span>)))</span></span></code></pre></div></div><p>But we'll need to wrap our sentinel-fn so we can call resolve</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>promise-new</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>reject</span>)
</span></span><span style=display:flex><span>                   (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>                                        (<span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> <span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>                                        (<span style=color:#50fa7b>funcall</span> <span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>event</span>))))
</span></span><span style=display:flex><span>                     (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;status&#34;</span>)
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#8be9fd;font-style:italic>sentinel-fn</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>promise-then</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute</span>)
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>status</span>)
</span></span><span style=display:flex><span>                  (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;%s&#34;</span> <span style=color:#8be9fd;font-style:italic>status</span>)))</span></span></code></pre></div></div><p>Now, I want to make the command the argument to <code>git-sync--execute</code>. Let's also rename it because it won't be the primary entry point and doesn't deserve something as simple as <code>execute</code></p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> (<span style=color:#8be9fd;font-style:italic>command</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>promise-new</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>reject</span>)
</span></span><span style=display:flex><span>                   (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>                                        (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>                                          (<span style=color:#8be9fd;font-style:italic>special-mode</span>)
</span></span><span style=display:flex><span>                                          (<span style=color:#50fa7b>funcall</span> <span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>event</span>)))))
</span></span><span style=display:flex><span>                     (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#8be9fd;font-style:italic>command</span>
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#8be9fd;font-style:italic>sentinel-fn</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>promise-then</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;status&#34;</span>))
</span></span><span style=display:flex><span>                (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>status</span>)
</span></span><span style=display:flex><span>                  (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;%s&#34;</span> <span style=color:#8be9fd;font-style:italic>status</span>)))</span></span></code></pre></div></div><p>Finally, I can sprinkle in some await magic</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>async-defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;add&#34;</span> <span style=color:#f1fa8c>&#34;.&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;commit&#34;</span> <span style=color:#f1fa8c>&#34;-m&#34;</span> <span style=color:#f1fa8c>&#34;\&#34;changes from Heimdall.localdomain on Wed Jan 24 09:29:28 PST 2024\&#34;&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;pull&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;push&#34;</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>git-sync--execute</span>)</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Bonus Commit Message</h3><div id=outline-text-headline-6 class=outline-text-3><p>I need to customize the commit message generated, and it can't just be a static string of my machine name and timestamp. Instead, I can use</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#50fa7b>format</span> <span style=color:#f1fa8c>&#34;changes from %s on %s&#34;</span> (<span style=color:#50fa7b>system-name</span>) (<span style=color:#50fa7b>current-time-string</span>))</span></span></code></pre></div></div><p>Which gets us</p><blockquote><p>changes from Heimdall.localdomain on Mon Jan 29 22:04:09 2024</p></blockquote></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>Summary</h3><div id=outline-text-headline-7 class=outline-text-3><p>Now, I've got most of the usability gripes with this package resolved.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>require</span> <span style=color:#f1fa8c>&#39;async-await</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defgroup</span> <span style=color:#8be9fd;font-style:italic>git-sync</span>
</span></span><span style=display:flex><span>    nil
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Customizations for git-sync&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> <span style=color:#ff79c6>&#39;</span>()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A list of files that git-sync is allowed to run in. In case of conflict with the deny-list, the deny-list wins out.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>director</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defcustom</span> <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#39;</span>()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A list of files that git-sync is not allowed to run in. In case of conflict with the allow-list, the deny-list wins out.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:type</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#8be9fd;font-style:italic>repeat</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:group</span> <span style=color:#f1fa8c>&#39;git-sync</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--commit-message</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#50fa7b>format</span> <span style=color:#f1fa8c>&#34;\&#34;changes from %s on %s \&#34;&#34;</span> (<span style=color:#50fa7b>system-name</span>) (<span style=color:#50fa7b>current-time-string</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Sentinel function for the git-sync process.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>with-current-buffer</span> (<span style=color:#50fa7b>process-buffer</span> <span style=color:#8be9fd;font-style:italic>process</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>read-only-mode</span> <span style=color:#bd93f9>-1</span>)
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>replace-regexp-in-region</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     &#34;</span> (<span style=color:#50fa7b>point-min</span>) (<span style=color:#50fa7b>point-max</span>))
</span></span><span style=display:flex><span>      (<span style=color:#50fa7b>goto-char</span> (<span style=color:#50fa7b>point-min</span>))
</span></span><span style=display:flex><span>      (<span style=color:#8be9fd;font-style:italic>special-mode</span>)))
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> (<span style=color:#8be9fd;font-style:italic>command</span>)
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Execute </span><span style=color:#f1fa8c>`COMMAND&#39;</span><span style=color:#f1fa8c> as a promise in the git-sync buffer.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  The promise returns the event passed in by the sentinel functions.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>promise-new</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>reject</span>)
</span></span><span style=display:flex><span>                   (<span style=color:#8be9fd;font-style:italic>let</span> ((<span style=color:#8be9fd;font-style:italic>sentinel-fn</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> (<span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>                                        (<span style=color:#8be9fd;font-style:italic>git-sync--sentinel-fn</span> <span style=color:#8be9fd;font-style:italic>process</span> <span style=color:#8be9fd;font-style:italic>event</span>)
</span></span><span style=display:flex><span>                                        (<span style=color:#50fa7b>funcall</span> <span style=color:#8be9fd;font-style:italic>resolve</span> <span style=color:#8be9fd;font-style:italic>event</span>))))
</span></span><span style=display:flex><span>                     (<span style=color:#8be9fd;font-style:italic>make-process</span> <span style=color:#8be9fd;font-style:italic>:name</span> <span style=color:#f1fa8c>&#34;git-sync&#34;</span>
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:buffer</span> (<span style=color:#50fa7b>get-buffer-create</span> <span style=color:#f1fa8c>&#34;*git-sync*&#34;</span>)
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:command</span> <span style=color:#8be9fd;font-style:italic>command</span>
</span></span><span style=display:flex><span>                                   <span style=color:#8be9fd;font-style:italic>:sentinel</span> <span style=color:#8be9fd;font-style:italic>sentinel-fn</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>async-defun</span> <span style=color:#8be9fd;font-style:italic>git-sync--execute</span> ()
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;add&#34;</span> <span style=color:#f1fa8c>&#34;.&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> (<span style=color:#50fa7b>list</span> <span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;commit&#34;</span> <span style=color:#f1fa8c>&#34;-m&#34;</span> (<span style=color:#8be9fd;font-style:italic>git-sync--commit-message</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;pull&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>await</span> (<span style=color:#8be9fd;font-style:italic>git-sync--execute-command</span> <span style=color:#ff79c6>&#39;</span>(<span style=color:#f1fa8c>&#34;git&#34;</span> <span style=color:#f1fa8c>&#34;push&#34;</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-allow-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add directory to the </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>read-directory-name</span> <span style=color:#f1fa8c>&#34;Directory to add to git-sync-allow-list: &#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-add-to-deny-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Add directory to the </span><span style=color:#f1fa8c>`git-sync-deny-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>interactive</span>)
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>read-directory-name</span> <span style=color:#f1fa8c>&#34;Directory to add to git-sync-deny-list: &#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-remove-from-allow-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Remove an item from the </span><span style=color:#f1fa8c>`git-sync-allow-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span> (<span style=color:#8be9fd;font-style:italic>remove</span> (<span style=color:#50fa7b>completing-read</span>
</span></span><span style=display:flex><span>                                       <span style=color:#f1fa8c>&#34;Select the item to remove: &#34;</span>
</span></span><span style=display:flex><span>                                       <span style=color:#8be9fd;font-style:italic>git-sync-allow-list</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-remove-from-deny-list</span> ()
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Remove an item from the </span><span style=color:#f1fa8c>`git-sync-deny-list&#39;</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span> (<span style=color:#8be9fd;font-style:italic>remove</span> (<span style=color:#50fa7b>completing-read</span>
</span></span><span style=display:flex><span>                                      <span style=color:#f1fa8c>&#34;Select the item to remove: &#34;</span>
</span></span><span style=display:flex><span>                                      <span style=color:#8be9fd;font-style:italic>git-sync-deny-list</span>))))</span></span></code></pre></div></div><p>My next question is, can I publish this to Melpa?</p></div></div></div><footer><section class=see-also><h3 id=see-also-in-sharpening-your-toolshed>See also in sharpening-your-toolshed
<a class=heading-link href=#see-also-in-sharpening-your-toolshed><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><nav><ul><li><a href=/posts/automating-git-sync-part-2/>Sharpening Your Toolshed: git-sync with a little polish</a></li><li><a href=/posts/automating-git-sync/>Sharpening Your Toolshed: Automating git-sync</a></li><li><a href=/posts/sharpening-your-toolshed/>Sharpening Your Toolshed</a></li></ul></nav></section></footer></article></section></div><footer class=footer><section class=container>Â©
2017 -
2024
Justin Barclay
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>