<!doctype html><html lang=en><head><title>Sharpening Your Toolshed: Automating git-sync Â· Justin Barclay
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Justin Barclay"><meta name=description content="How to automate git-sync by creating an Emacs minor mode"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sharpening Your Toolshed: Automating git-sync"><meta name=twitter:description content="How to automate git-sync by creating an Emacs minor mode"><meta property="og:title" content="Sharpening Your Toolshed: Automating git-sync"><meta property="og:description" content="How to automate git-sync by creating an Emacs minor mode"><meta property="og:type" content="article"><meta property="og:url" content="https://justinbarclay.ca/posts/automating-git-sync/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-12T00:00:00+00:00"><meta property="og:see_also" content="https://justinbarclay.ca/posts/sanding-down-git-sync/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/automating-git-sync-part-2/"><meta property="og:see_also" content="https://justinbarclay.ca/posts/sharpening-your-toolshed/"><link rel=canonical href=https://justinbarclay.ca/posts/automating-git-sync/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.6ae16217aee047e8670f870029572173bda1b44657408baa3eb8da2490610c18.css integrity="sha256-auFiF67gR+hnD4cAKVchc72htEZXQIuqPrjaJJBhDBg=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.121.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Justin Barclay
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://justinbarclay.ca/posts/automating-git-sync/>Sharpening Your Toolshed: Automating git-sync</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-10-24T00:00:00Z>October 24, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div></div></header><div class=post-content><p><div class=banner-image></p><img src=/images/sharpening-your-toolshed.png alt='"Two programmers sharpening the first toolshed"' title=/images/sharpening-your-toolshed.png><p></div></p><p>I've been trying to write more this year. To help with that, I've embraced the idea of diarying. Since I primarily use a computer for writing, I wanted a tool that could foster a more interconnected thinking style. That's when I stumbled upon <a href=https://github.com/org-roam/org-roam>org-roam</a>, an extension for <a href=https://orgmode.org/>org-mode</a> that seamlessly integrates with the <a href=https://en.wikipedia.org/wiki/Zettelkasten>Zettelkasten</a> style of note-taking.</p><p>I value <code>org-mode</code> for its straightforward syntax, which enables me to write simple notes. For my most basic needs, I often record a quote and a link to its source</p><div class="src src-org-mode"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#+title: Zettelkasten
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#+begin_quote
</span></span><span style=display:flex><span>A Zettelkasten (German for &#34;slip box,&#34; plural ZettelkÃ¤sten) or card file consists of small items of information stored on paper slips or cards that may be linked to each other through subject headings or other metadata such as numbers and tags. It has often been used as a system of note-taking and personal knowledge management for research, study, and writing.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>In the 1980s, the card file began to be used as metaphor in the interface of some hypertextual personal knowledge base software applications such as NoteCards. In the 1990s, such software inspired the invention of wikis.
</span></span><span style=display:flex><span>#+end_quote
</span></span><span style=display:flex><span>* Link
</span></span><span style=display:flex><span>https://en.wikipedia.org/wiki/Zettelkasten</span></span></code></pre></div></div><p>Yet, there are times when my notes take on a more complicated form, such as a comprehensive development journal complete with images, links, citations, and live code examples -â€” much like a <a href=https://jupyter.org/>Jupyter Notebook</a>.</p><div class="src src-org-mode"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>We know we can talk to SSH on Windows, but can we still gain access to 1Password? Well, we can verify that by calling ssh-add.exe:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#+begin_src powershell
</span></span><span style=display:flex><span>ssh-add.exe -L
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># or /mnt/c/WINDOWS/System32/OpenSSH//ssh-add.exe -L
</span></span><span style=display:flex><span>\#+end_src 
</span></span><span style=display:flex><span>And it should show you the SSH keys you have stored in 1Password:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#+RESULTS:
</span></span><span style=display:flex><span>| ssh-ed25519 | AAAAC3NzaC1lZDI1NTE5AAAAIGFbygxEvFlS66vaugGRlbXR12yjozS8G+yYrK23lmZo | SSH | Signing | Key |
</span></span><span style=display:flex><span>| ssh-ed25519 | AAAAC3NzaC1lZDI1NTE5AAAAIHyfKl/29RIys3r+UsyM6ODnh04tI01iUBeBjornOrnl | SSH | Auth    | Key |
</span></span><span style=display:flex><span>#+end_quote</span></span></code></pre></div></div><p>I like that org-roam allows for more networked thoughts similar to tools like <a href=https://roamresearch.com/>Roam</a> or <a href=https://obsidian.md/>Obsidian</a>. <code>org-roam</code> focuses on being plain text first and enhancing the writing experience from there. Due to this, it is a portable format and allows me to write anywhere I have a computer and a text editor.</p><p>The idea of plain text being portable and under my control, rather than living on someone else's computer by default, is compelling. However, there is still the challenge where I need my writing to exist across multiple machines and platforms. Ideally, I'd have my notes accessible from all my computers.</p><p><code>org-roam</code> falls slightly short when compared to its competitors. It doesn't offer cloud synchronization. While I appreciate the privacy of having my data live locally, I also value convenience. Therefore, I'd like to find a solution that allows files to sync with minimal input, ensuring a smooth transition from one machine to another without disrupting my workflow.</p><p>Moreover, I'd prefer a solution that's versatile, compatible across macOS, Linux, and Windows, and capable of working seamlessly with Git. Using Git would provide the best of both worlds â€“ cloud-like convenience under my terms and the security of owning my data.</p><p>This is where <a href=https://github.com/simonthum/git-sync>git-sync</a> comes into play. <code>git-sync</code> is a simple bash <a href=https://github.com/simonthum/git-sync/blob/master/git-sync>script</a> that runs something akin to git fetch + commit + push.</p><p><code>git-sync</code> does come with a significant downside: the user has to trigger a sync operation themselves. It's not all gloom and doom; however, there are ways to automate the task. For instance, you could use something like <a href=https://linux.die.net/man/7/inotify>inotify</a> to trigger git-sync. Unfortunately, <a href=https://en.wikipedia.org/wiki/Inotify>inotify</a> is Linux only.</p><p>Luckily, I have another solution, one that uses a Lisp. So it's much nicer to script in than something like bash (ðŸ¤®). The solution, obviously, is <a href=https://www.gnu.org/software/emacs/>Emacs</a>.</p><p>Emacs has a bunch of <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Standard-Hooks.html>hooks</a> that allow you to modify the system after an event. For instance, the <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Saving-Buffers.html#index-after_002dsave_002dhook>after-save-hook</a>, which is the hook we want to use, runs a list of functions after a <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Buffers.html>buffer</a> is saved. So, all we have to do is call <code>git-sync</code> after the user saves the buffer.</p><p>So, if we evaluate the function below, Emacs will call <code>git-sync</code> every time a file is saved.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>add-to-list</span> <span style=color:#f1fa8c>&#39;after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> () (<span style=color:#8be9fd;font-style:italic>async-shell-command</span>  <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>)))</span></span></code></pre></div></div><p>But this also raises a problem. Emacs will call git-sync every time a file is saved. Even on the files, I don't want to be saved. I only want it to run when <span style=text-decoration:underline>specific</span> files are saved. Luckily, we can accomplish this by using <code>setq-local</code>.</p><p>You could think of <code>add-to-list</code> as:</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>setq</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> () (<span style=color:#8be9fd;font-style:italic>async-shell-command</span>  <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>)) <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))</span></span></code></pre></div></div><p>So, we need to replace <code>setq</code> with <code>setq-local</code>, and we'll have git-sync only run in the current buffer.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>(<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> (<span style=color:#8be9fd;font-style:italic>lambda</span> () (<span style=color:#8be9fd;font-style:italic>async-shell-command</span>  <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>)) <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))</span></span></code></pre></div></div><p>If I formalize this lambda into a function, <code>git-sync-after-save</code>, things become a bit easier to read:</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>defun</span> <span style=color:#8be9fd;font-style:italic>git-sync-after-save</span> ()
</span></span><span style=display:flex><span>   (<span style=color:#8be9fd;font-style:italic>async-shell-command</span>  <span style=color:#f1fa8c>&#34;git-sync -n -s&#34;</span>))</span></span></code></pre></div></div><p>But they also make it so that some things are easier to clean up as well</p><div class="src src-emacs-lisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>)</span></span></code></pre></div></div><p>I now know how to get git-sync to run across all buffers in Emacs or for a single buffer. However, remember, I want to automate this. So, I want Emacs to run git-sync for me only on specific projects.</p><p>We can use a feature in Emacs' called <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Minor-Modes.html>minor modes</a>.</p><blockquote><p>A minor mode is an optional editing mode that alters the behaviour of Emacs in some well-defined way.</p><ul><li>Gnu Emacs'</li></ul></blockquote><p>To define a minor mode, you call the macro <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Defining-Minor-Modes.html><code>define-minor-mode</code></a> and pass it a plist with the keys <code>:global</code>, <code>:init-value</code>, <code>:lighter</code>, <code>:keymap</code>, <code>:variable</code>, <code>:after-hook</code>, <code>:interactive</code>. But we only really care about <code>:lighter</code>, and <code>:after-hook</code>. <code>:lighter</code> is a string that displays in the mode line as an indicator that the minor mode is active. And <code>:after-hook</code> is a lisp form that Emacs will run when the minor mode is activated and deactivated.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>some-minor-mode</span>
</span></span><span style=display:flex><span>                   (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;we&#39;re doing some work for some-minor-mode&#34;</span>)
</span></span><span style=display:flex><span>                 (<span style=color:#50fa7b>message</span> <span style=color:#f1fa8c>&#34;we&#39;re cleaning up from some-minor-mode&#34;</span>)))</span></span></code></pre></div></div><p>But for our <code>:after-hook</code>, we simply need to add or remove the <code>git-sync-after-save-hook</code> to the buffer-local <code>after-save-hook</code> list.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>  (<span style=color:#8be9fd;font-style:italic>define-minor-mode</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>;; Add minor mode documentation here</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;A minor mode to run git-sync on save.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:lighter</span> <span style=color:#f1fa8c>&#34; git-sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>:after-hook</span> (<span style=color:#8be9fd;font-style:italic>if</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>
</span></span><span style=display:flex><span>                    (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#50fa7b>cons</span> <span style=color:#f1fa8c>&#39;git-sync-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#8be9fd;font-style:italic>setq-local</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span> (<span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#f1fa8c>&#39;git-sync-after-save</span> <span style=color:#8be9fd;font-style:italic>after-save-hook</span>))))</span></span></code></pre></div></div><p>Now that we have defined <code>git-sync-mode</code>, we need to figure out how to turn it on. For that, I am going to keep things simple and use <a href=https://www.gnu.org/software/emacs/manual/html_node/emacs/Directory-Variables.html>.dir-locals.el</a> to turn on <code>git-sync-mode</code> in the appropriate directories. <code>.dir-locals.el</code> is Emacs' way of defining directory local variables, kind of like a <a href="https://www.ibm.com/docs/en/aix/7.2?topic=files-env-file">.env</a> file.</p><p>A <code>.dir-locals.el</code> file is written as a list of cons cells with the major mode and the list of variable/value pairs.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>((<span style=color:#8be9fd;font-style:italic>major-mode</span> <span style=color:#ff79c6>.</span> ((<span style=color:#8be9fd;font-style:italic>some-variable</span> <span style=color:#8be9fd;font-style:italic>some-value</span>))))</span></span></code></pre></div></div><p>But we want <code>git-sync-mode</code> to run in all major modes. So, instead of associating git-sync with a specific major mode, we can associate it with <code>nil</code>, which will tell Emacs to set these variables in every buffer associated with this directory.</p><div class="src src-elisp"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span>((nil <span style=color:#ff79c6>.</span> ((<span style=color:#8be9fd;font-style:italic>mode</span> <span style=color:#ff79c6>.</span> <span style=color:#8be9fd;font-style:italic>git-sync-mode</span>))))</span></span></code></pre></div></div><p>And that is the beauty of minor modes. Users can use little programs to modify their buffers and files or attach behaviour to their buffers.</p><p style=font-style:italic>Build small tools for yourself. After all, our toolsheds aren't going to sharpen themselves.</p><blockquote><p>Check out <a href=/posts/automating-git-sync-part-2>part 2</a> where I add a little bit of polish so it's less annoying to work with.</p></blockquote></div><footer><section class=see-also><h3 id=see-also-in-sharpening-your-toolshed>See also in sharpening-your-toolshed
<a class=heading-link href=#see-also-in-sharpening-your-toolshed><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><nav><ul><li><a href=/posts/sanding-down-git-sync/>Sharpening Your Toolshed: Sanding down the rough edges of git-sync</a></li><li><a href=/posts/automating-git-sync-part-2/>Sharpening Your Toolshed: git-sync with a little polish</a></li><li><a href=/posts/sharpening-your-toolshed/>Sharpening Your Toolshed</a></li></ul></nav></section></footer></article></section></div><footer class=footer><section class=container>Â©
2017 -
2024
Justin Barclay
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>